{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _CommonEncryption = require('./../CommonEncryption');\n\nvar _CommonEncryption2 = _interopRequireDefault(_CommonEncryption);\n\nvar _KeySystemClearKey = require('./../drm/KeySystemClearKey');\n\nvar _KeySystemClearKey2 = _interopRequireDefault(_KeySystemClearKey);\n\nvar _KeySystemW3CClearKey = require('./../drm/KeySystemW3CClearKey');\n\nvar _KeySystemW3CClearKey2 = _interopRequireDefault(_KeySystemW3CClearKey);\n\nvar _KeySystemWidevine = require('./../drm/KeySystemWidevine');\n\nvar _KeySystemWidevine2 = _interopRequireDefault(_KeySystemWidevine);\n\nvar _KeySystemPlayReady = require('./../drm/KeySystemPlayReady');\n\nvar _KeySystemPlayReady2 = _interopRequireDefault(_KeySystemPlayReady);\n\nvar _DRMToday = require('./../servers/DRMToday');\n\nvar _DRMToday2 = _interopRequireDefault(_DRMToday);\n\nvar _PlayReady = require('./../servers/PlayReady');\n\nvar _PlayReady2 = _interopRequireDefault(_PlayReady);\n\nvar _Widevine = require('./../servers/Widevine');\n\nvar _Widevine2 = _interopRequireDefault(_Widevine);\n\nvar _ClearKey = require('./../servers/ClearKey');\n\nvar _ClearKey2 = _interopRequireDefault(_ClearKey);\n\nvar _ProtectionConstants = require('../../constants/ProtectionConstants');\n\nvar _ProtectionConstants2 = _interopRequireDefault(_ProtectionConstants);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n/**\n* @module ProtectionKeyController\n* @ignore\n* @description Media protection key system functionality that can be modified/overridden by applications\n*/\n\n/**\n* The copyright in this software is being made available under the BSD License,\n* included below. This software may be subject to other third party and contributor\n* rights, including patent rights, and no such rights are granted under this license.\n*\n* Copyright (c) 2013, Dash Industry Forum.\n* All rights reserved.\n*\n* Redistribution and use in source and binary forms, with or without modification,\n* are permitted provided that the following conditions are met:\n*  * Redistributions of source code must retain the above copyright notice, this\n*  list of conditions and the following disclaimer.\n*  * Redistributions in binary form must reproduce the above copyright notice,\n*  this list of conditions and the following disclaimer in the documentation and/or\n*  other materials provided with the distribution.\n*  * Neither the name of Dash Industry Forum nor the names of its\n*  contributors may be used to endorse or promote products derived from this software\n*  without specific prior written permission.\n*\n*  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n*  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n*  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n*  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n*  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n*  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n*  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n*  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n*  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n*  POSSIBILITY OF SUCH DAMAGE.\n*/\n\n\nfunction ProtectionKeyController() {\n  var context = this.context;\n  var instance = void 0,\n      debug = void 0,\n      logger = void 0,\n      keySystems = void 0,\n      BASE64 = void 0,\n      clearkeyKeySystem = void 0,\n      clearkeyW3CKeySystem = void 0;\n\n  function setConfig(config) {\n    if (!config) return;\n\n    if (config.debug) {\n      debug = config.debug;\n      logger = debug.getLogger(instance);\n    }\n\n    if (config.BASE64) {\n      BASE64 = config.BASE64;\n    }\n  }\n\n  function initialize() {\n    keySystems = [];\n    var keySystem = void 0; // PlayReady\n\n    keySystem = (0, _KeySystemPlayReady2.default)(context).getInstance({\n      BASE64: BASE64\n    });\n    keySystems.push(keySystem); // Widevine\n\n    keySystem = (0, _KeySystemWidevine2.default)(context).getInstance({\n      BASE64: BASE64\n    });\n    keySystems.push(keySystem); // ClearKey\n\n    keySystem = (0, _KeySystemClearKey2.default)(context).getInstance({\n      BASE64: BASE64\n    });\n    keySystems.push(keySystem);\n    clearkeyKeySystem = keySystem; // W3C ClearKey\n\n    keySystem = (0, _KeySystemW3CClearKey2.default)(context).getInstance({\n      BASE64: BASE64,\n      debug: debug\n    });\n    keySystems.push(keySystem);\n    clearkeyW3CKeySystem = keySystem;\n  }\n  /**\n  * Returns a prioritized list of key systems supported\n  * by this player (not necessarily those supported by the\n  * user agent)\n  *\n  * @returns {Array.<KeySystem>} a prioritized\n  * list of key systems\n  * @memberof module:ProtectionKeyController\n  * @instance\n  */\n\n\n  function getKeySystems() {\n    return keySystems;\n  }\n  /**\n  * Sets the prioritized list of key systems to be supported\n  * by this player.\n  *\n  * @param {Array.<KeySystem>} newKeySystems the new prioritized\n  * list of key systems\n  * @memberof module:ProtectionKeyController\n  * @instance\n  */\n\n\n  function setKeySystems(newKeySystems) {\n    keySystems = newKeySystems;\n  }\n  /**\n  * Returns the key system associated with the given key system string\n  * name (i.e. 'org.w3.clearkey')\n  *\n  * @param {string} systemString the system string\n  * @returns {KeySystem|null} the key system\n  * or null if no supported key system is associated with the given key\n  * system string\n  * @memberof module:ProtectionKeyController\n  * @instance\n  */\n\n\n  function getKeySystemBySystemString(systemString) {\n    for (var i = 0; i < keySystems.length; i++) {\n      if (keySystems[i].systemString === systemString) {\n        return keySystems[i];\n      }\n    }\n\n    return null;\n  }\n  /**\n  * Determines whether the given key system is ClearKey.  This is\n  * necessary because the EME spec defines ClearKey and its method\n  * for providing keys to the key session; and this method has changed\n  * between the various API versions.  Our EME-specific ProtectionModels\n  * must know if the system is ClearKey so that it can format the keys\n  * according to the particular spec version.\n  *\n  * @param {Object} keySystem the key\n  * @returns {boolean} true if this is the ClearKey key system, false\n  * otherwise\n  * @memberof module:ProtectionKeyController\n  * @instance\n  */\n\n\n  function isClearKey(keySystem) {\n    return keySystem === clearkeyKeySystem || keySystem === clearkeyW3CKeySystem;\n  }\n  /**\n  * Check equality of initData array buffers.\n  *\n  * @param {ArrayBuffer} initData1 - first initData\n  * @param {ArrayBuffer} initData2 - second initData\n  * @returns {boolean} true if the initData arrays are equal in size and\n  * contents, false otherwise\n  * @memberof module:ProtectionKeyController\n  * @instance\n  */\n\n\n  function initDataEquals(initData1, initData2) {\n    if (initData1.byteLength === initData2.byteLength) {\n      var data1 = new Uint8Array(initData1);\n      var data2 = new Uint8Array(initData2);\n\n      for (var j = 0; j < data1.length; j++) {\n        if (data1[j] !== data2[j]) {\n          return false;\n        }\n      }\n\n      return true;\n    }\n\n    return false;\n  }\n  /**\n  * Returns a set of supported key systems and CENC initialization data\n  * from the given array of ContentProtection elements.  Only\n  * key systems that are supported by this player will be returned.\n  * Key systems are returned in priority order (highest first).\n  *\n  * @param {Array.<Object>} cps - array of content protection elements parsed\n  * from the manifest\n  * @returns {Array.<Object>} array of objects indicating which supported key\n  * systems were found.  Empty array is returned if no\n  * supported key systems were found\n  * @memberof module:ProtectionKeyController\n  * @instance\n  */\n\n\n  function getSupportedKeySystemsFromContentProtection(cps) {\n    var cp = void 0,\n        ks = void 0,\n        ksIdx = void 0,\n        cpIdx = void 0;\n    var supportedKS = [];\n\n    if (cps) {\n      var cencContentProtection = _CommonEncryption2.default.findCencContentProtection(cps);\n\n      for (ksIdx = 0; ksIdx < keySystems.length; ++ksIdx) {\n        ks = keySystems[ksIdx];\n\n        for (cpIdx = 0; cpIdx < cps.length; ++cpIdx) {\n          cp = cps[cpIdx];\n\n          if (cp.schemeIdUri.toLowerCase() === ks.schemeIdURI) {\n            // Look for DRM-specific ContentProtection\n            var initData = ks.getInitData(cp, cencContentProtection);\n            supportedKS.push({\n              ks: keySystems[ksIdx],\n              initData: initData,\n              cdmData: ks.getCDMData(),\n              sessionId: ks.getSessionId(cp)\n            });\n          }\n        }\n      }\n    }\n\n    return supportedKS;\n  }\n  /**\n  * Returns key systems supported by this player for the given PSSH\n  * initializationData. Only key systems supported by this player\n  * that have protection data present will be returned.  Key systems are returned in priority order\n  * (highest priority first)\n  *\n  * @param {ArrayBuffer} initData Concatenated PSSH data for all DRMs\n  * supported by the content\n  * @param {ProtectionData} protDataSet user specified protection data - license server url etc\n  * supported by the content\n  * @returns {Array.<Object>} array of objects indicating which supported key\n  * systems were found.  Empty array is returned if no\n  * supported key systems were found\n  * @memberof module:ProtectionKeyController\n  * @instance\n  */\n\n\n  function getSupportedKeySystems(initData, protDataSet) {\n    var supportedKS = [];\n\n    var pssh = _CommonEncryption2.default.parsePSSHList(initData);\n\n    var ks = void 0,\n        keySystemString = void 0,\n        shouldNotFilterOutKeySystem = void 0;\n\n    for (var ksIdx = 0; ksIdx < keySystems.length; ++ksIdx) {\n      ks = keySystems[ksIdx];\n      keySystemString = ks.systemString;\n      shouldNotFilterOutKeySystem = protDataSet ? keySystemString in protDataSet : true;\n\n      if (ks.uuid in pssh && shouldNotFilterOutKeySystem) {\n        supportedKS.push({\n          ks: ks,\n          initData: pssh[ks.uuid],\n          cdmData: ks.getCDMData(),\n          sessionId: ks.getSessionId()\n        });\n      }\n    }\n\n    return supportedKS;\n  }\n  /**\n  * Returns the license server implementation data that should be used for this request.\n  *\n  * @param {KeySystem} keySystem the key system\n  * associated with this license request\n  * @param {ProtectionData} protData protection data to use for the\n  * request\n  * @param {string} [messageType=\"license-request\"] the message type associated with this\n  * request.  Supported message types can be found\n  * {@link https://w3c.github.io/encrypted-media/#idl-def-MediaKeyMessageType|here}.\n  * @returns {LicenseServer|null} the license server\n  * implementation that should be used for this request or null if the player should not\n  * pass messages of the given type to a license server\n  * @memberof module:ProtectionKeyController\n  * @instance\n  *\n  */\n\n\n  function getLicenseServer(keySystem, protData, messageType) {\n    // Our default server implementations do not do anything with \"license-release\" or\n    // \"individualization-request\" messages, so we just send a success event\n    if (messageType === 'license-release' || messageType === 'individualization-request') {\n      return null;\n    }\n\n    var licenseServerData = null;\n\n    if (protData && protData.hasOwnProperty('drmtoday')) {\n      licenseServerData = (0, _DRMToday2.default)(context).getInstance({\n        BASE64: BASE64\n      });\n    } else if (keySystem.systemString === _ProtectionConstants2.default.WIDEVINE_KEYSTEM_STRING) {\n      licenseServerData = (0, _Widevine2.default)(context).getInstance();\n    } else if (keySystem.systemString === _ProtectionConstants2.default.PLAYREADY_KEYSTEM_STRING) {\n      licenseServerData = (0, _PlayReady2.default)(context).getInstance();\n    } else if (keySystem.systemString === _ProtectionConstants2.default.CLEARKEY_KEYSTEM_STRING) {\n      licenseServerData = (0, _ClearKey2.default)(context).getInstance();\n    }\n\n    return licenseServerData;\n  }\n  /**\n  * Allows application-specific retrieval of ClearKey keys.\n  *\n  * @param {KeySystem} clearkeyKeySystem They exact ClearKey System to be used\n  * @param {ProtectionData} protData protection data to use for the\n  * request\n  * @param {ArrayBuffer} message the key message from the CDM\n  * @return {ClearKeyKeySet|null} the clear keys associated with\n  * the request or null if no keys can be returned by this function\n  * @memberof module:ProtectionKeyController\n  * @instance\n  */\n\n\n  function processClearKeyLicenseRequest(clearkeyKeySystem, protData, message) {\n    try {\n      return clearkeyKeySystem.getClearKeysFromProtectionData(protData, message);\n    } catch (error) {\n      logger.error('Failed to retrieve clearkeys from ProtectionData');\n      return null;\n    }\n  }\n\n  function setProtectionData(protectionDataSet) {\n    var getProtectionData = function getProtectionData(keySystemString) {\n      var protData = null;\n\n      if (protectionDataSet) {\n        protData = keySystemString in protectionDataSet ? protectionDataSet[keySystemString] : null;\n      }\n\n      return protData;\n    };\n\n    for (var i = 0; i < keySystems.length; i++) {\n      var keySystem = keySystems[i];\n\n      if (keySystem.hasOwnProperty('init')) {\n        keySystem.init(getProtectionData(keySystem.systemString));\n      }\n    }\n  }\n\n  instance = {\n    initialize: initialize,\n    setProtectionData: setProtectionData,\n    isClearKey: isClearKey,\n    initDataEquals: initDataEquals,\n    getKeySystems: getKeySystems,\n    setKeySystems: setKeySystems,\n    getKeySystemBySystemString: getKeySystemBySystemString,\n    getSupportedKeySystemsFromContentProtection: getSupportedKeySystemsFromContentProtection,\n    getSupportedKeySystems: getSupportedKeySystems,\n    getLicenseServer: getLicenseServer,\n    processClearKeyLicenseRequest: processClearKeyLicenseRequest,\n    setConfig: setConfig\n  };\n  return instance;\n}\n\nProtectionKeyController.__dashjs_factory_name = 'ProtectionKeyController';\nexports.default = dashjs.FactoryMaker.getSingletonFactory(ProtectionKeyController);\n/* jshint ignore:line */","map":{"version":3,"mappings":"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","names":["ProtectionKeyController","context","instance","debug","logger","keySystems","BASE64","clearkeyKeySystem","clearkeyW3CKeySystem","setConfig","config","getLogger","initialize","keySystem","getInstance","push","getKeySystems","setKeySystems","newKeySystems","getKeySystemBySystemString","systemString","i","length","isClearKey","initDataEquals","initData1","initData2","byteLength","data1","Uint8Array","data2","j","getSupportedKeySystemsFromContentProtection","cps","cp","ks","ksIdx","cpIdx","supportedKS","cencContentProtection","CommonEncryption","findCencContentProtection","schemeIdUri","toLowerCase","schemeIdURI","initData","getInitData","cdmData","getCDMData","sessionId","getSessionId","getSupportedKeySystems","protDataSet","pssh","parsePSSHList","keySystemString","shouldNotFilterOutKeySystem","uuid","getLicenseServer","protData","messageType","licenseServerData","hasOwnProperty","ProtectionConstants","WIDEVINE_KEYSTEM_STRING","PLAYREADY_KEYSTEM_STRING","CLEARKEY_KEYSTEM_STRING","processClearKeyLicenseRequest","message","getClearKeysFromProtectionData","error","setProtectionData","protectionDataSet","getProtectionData","init","__dashjs_factory_name","dashjs","FactoryMaker","getSingletonFactory"],"sources":["/home/landsys/react-node-video-streaming/client/node_modules/dashjs/src/streaming/protection/controllers/ProtectionKeyController.js"],"sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport CommonEncryption from './../CommonEncryption';\nimport KeySystemClearKey from './../drm/KeySystemClearKey';\nimport KeySystemW3CClearKey from './../drm/KeySystemW3CClearKey';\nimport KeySystemWidevine from './../drm/KeySystemWidevine';\nimport KeySystemPlayReady from './../drm/KeySystemPlayReady';\nimport DRMToday from './../servers/DRMToday';\nimport PlayReady from './../servers/PlayReady';\nimport Widevine from './../servers/Widevine';\nimport ClearKey from './../servers/ClearKey';\nimport ProtectionConstants from '../../constants/ProtectionConstants';\n\n/**\n * @module ProtectionKeyController\n * @ignore\n * @description Media protection key system functionality that can be modified/overridden by applications\n */\nfunction ProtectionKeyController() {\n\n    let context = this.context;\n\n    let instance,\n        debug,\n        logger,\n        keySystems,\n        BASE64,\n        clearkeyKeySystem,\n        clearkeyW3CKeySystem;\n\n    function setConfig(config) {\n        if (!config) return;\n\n        if (config.debug) {\n            debug = config.debug;\n            logger = debug.getLogger(instance);\n        }\n\n        if (config.BASE64) {\n            BASE64 = config.BASE64;\n        }\n    }\n\n    function initialize() {\n        keySystems = [];\n\n        let keySystem;\n\n        // PlayReady\n        keySystem = KeySystemPlayReady(context).getInstance({BASE64: BASE64});\n        keySystems.push(keySystem);\n\n        // Widevine\n        keySystem = KeySystemWidevine(context).getInstance({BASE64: BASE64});\n        keySystems.push(keySystem);\n\n        // ClearKey\n        keySystem = KeySystemClearKey(context).getInstance({BASE64: BASE64});\n        keySystems.push(keySystem);\n        clearkeyKeySystem = keySystem;\n\n        // W3C ClearKey\n        keySystem = KeySystemW3CClearKey(context).getInstance({BASE64: BASE64, debug: debug});\n        keySystems.push(keySystem);\n        clearkeyW3CKeySystem = keySystem;\n    }\n\n    /**\n     * Returns a prioritized list of key systems supported\n     * by this player (not necessarily those supported by the\n     * user agent)\n     *\n     * @returns {Array.<KeySystem>} a prioritized\n     * list of key systems\n     * @memberof module:ProtectionKeyController\n     * @instance\n     */\n    function getKeySystems() {\n        return keySystems;\n    }\n\n    /**\n     * Sets the prioritized list of key systems to be supported\n     * by this player.\n     *\n     * @param {Array.<KeySystem>} newKeySystems the new prioritized\n     * list of key systems\n     * @memberof module:ProtectionKeyController\n     * @instance\n     */\n    function setKeySystems(newKeySystems) {\n        keySystems = newKeySystems;\n    }\n\n    /**\n     * Returns the key system associated with the given key system string\n     * name (i.e. 'org.w3.clearkey')\n     *\n     * @param {string} systemString the system string\n     * @returns {KeySystem|null} the key system\n     * or null if no supported key system is associated with the given key\n     * system string\n     * @memberof module:ProtectionKeyController\n     * @instance\n     */\n    function getKeySystemBySystemString(systemString) {\n        for (let i = 0; i < keySystems.length; i++) {\n            if (keySystems[i].systemString === systemString) {\n                return keySystems[i];\n            }\n        }\n        return null;\n    }\n\n    /**\n     * Determines whether the given key system is ClearKey.  This is\n     * necessary because the EME spec defines ClearKey and its method\n     * for providing keys to the key session; and this method has changed\n     * between the various API versions.  Our EME-specific ProtectionModels\n     * must know if the system is ClearKey so that it can format the keys\n     * according to the particular spec version.\n     *\n     * @param {Object} keySystem the key\n     * @returns {boolean} true if this is the ClearKey key system, false\n     * otherwise\n     * @memberof module:ProtectionKeyController\n     * @instance\n     */\n    function isClearKey(keySystem) {\n        return (keySystem === clearkeyKeySystem || keySystem === clearkeyW3CKeySystem);\n    }\n\n    /**\n     * Check equality of initData array buffers.\n     *\n     * @param {ArrayBuffer} initData1 - first initData\n     * @param {ArrayBuffer} initData2 - second initData\n     * @returns {boolean} true if the initData arrays are equal in size and\n     * contents, false otherwise\n     * @memberof module:ProtectionKeyController\n     * @instance\n     */\n    function initDataEquals(initData1, initData2) {\n        if (initData1.byteLength === initData2.byteLength) {\n            let data1 = new Uint8Array(initData1);\n            let data2 = new Uint8Array(initData2);\n\n            for (let j = 0; j < data1.length; j++) {\n                if (data1[j] !== data2[j]) {\n                    return false;\n                }\n            }\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * Returns a set of supported key systems and CENC initialization data\n     * from the given array of ContentProtection elements.  Only\n     * key systems that are supported by this player will be returned.\n     * Key systems are returned in priority order (highest first).\n     *\n     * @param {Array.<Object>} cps - array of content protection elements parsed\n     * from the manifest\n     * @returns {Array.<Object>} array of objects indicating which supported key\n     * systems were found.  Empty array is returned if no\n     * supported key systems were found\n     * @memberof module:ProtectionKeyController\n     * @instance\n     */\n    function getSupportedKeySystemsFromContentProtection(cps) {\n        let cp, ks, ksIdx, cpIdx;\n        let supportedKS = [];\n\n        if (cps) {\n            const cencContentProtection = CommonEncryption.findCencContentProtection(cps);\n            for (ksIdx = 0; ksIdx < keySystems.length; ++ksIdx) {\n                ks = keySystems[ksIdx];\n                for (cpIdx = 0; cpIdx < cps.length; ++cpIdx) {\n                    cp = cps[cpIdx];\n                    if (cp.schemeIdUri.toLowerCase() === ks.schemeIdURI) {\n                        // Look for DRM-specific ContentProtection\n                        let initData = ks.getInitData(cp, cencContentProtection);\n\n                        supportedKS.push({\n                            ks: keySystems[ksIdx],\n                            initData: initData,\n                            cdmData: ks.getCDMData(),\n                            sessionId: ks.getSessionId(cp)\n                        });\n                    }\n                }\n            }\n        }\n        return supportedKS;\n    }\n\n    /**\n     * Returns key systems supported by this player for the given PSSH\n     * initializationData. Only key systems supported by this player\n     * that have protection data present will be returned.  Key systems are returned in priority order\n     * (highest priority first)\n     *\n     * @param {ArrayBuffer} initData Concatenated PSSH data for all DRMs\n     * supported by the content\n     * @param {ProtectionData} protDataSet user specified protection data - license server url etc\n     * supported by the content\n     * @returns {Array.<Object>} array of objects indicating which supported key\n     * systems were found.  Empty array is returned if no\n     * supported key systems were found\n     * @memberof module:ProtectionKeyController\n     * @instance\n     */\n    function getSupportedKeySystems(initData, protDataSet) {\n        let supportedKS = [];\n        let pssh = CommonEncryption.parsePSSHList(initData);\n        let ks, keySystemString, shouldNotFilterOutKeySystem;\n\n        for (let ksIdx = 0; ksIdx < keySystems.length; ++ksIdx) {\n            ks = keySystems[ksIdx];\n            keySystemString = ks.systemString;\n            shouldNotFilterOutKeySystem = (protDataSet) ? keySystemString in protDataSet : true;\n\n            if (ks.uuid in pssh && shouldNotFilterOutKeySystem) {\n                supportedKS.push({\n                    ks: ks,\n                    initData: pssh[ks.uuid],\n                    cdmData: ks.getCDMData(),\n                    sessionId: ks.getSessionId()\n                });\n            }\n        }\n        return supportedKS;\n    }\n\n    /**\n     * Returns the license server implementation data that should be used for this request.\n     *\n     * @param {KeySystem} keySystem the key system\n     * associated with this license request\n     * @param {ProtectionData} protData protection data to use for the\n     * request\n     * @param {string} [messageType=\"license-request\"] the message type associated with this\n     * request.  Supported message types can be found\n     * {@link https://w3c.github.io/encrypted-media/#idl-def-MediaKeyMessageType|here}.\n     * @returns {LicenseServer|null} the license server\n     * implementation that should be used for this request or null if the player should not\n     * pass messages of the given type to a license server\n     * @memberof module:ProtectionKeyController\n     * @instance\n     *\n     */\n    function getLicenseServer(keySystem, protData, messageType) {\n\n        // Our default server implementations do not do anything with \"license-release\" or\n        // \"individualization-request\" messages, so we just send a success event\n        if (messageType === 'license-release' || messageType === 'individualization-request') {\n            return null;\n        }\n\n        let licenseServerData = null;\n        if (protData && protData.hasOwnProperty('drmtoday')) {\n            licenseServerData = DRMToday(context).getInstance({BASE64: BASE64});\n        } else if (keySystem.systemString === ProtectionConstants.WIDEVINE_KEYSTEM_STRING) {\n            licenseServerData = Widevine(context).getInstance();\n        } else if (keySystem.systemString === ProtectionConstants.PLAYREADY_KEYSTEM_STRING) {\n            licenseServerData = PlayReady(context).getInstance();\n        } else if (keySystem.systemString === ProtectionConstants.CLEARKEY_KEYSTEM_STRING) {\n            licenseServerData = ClearKey(context).getInstance();\n        }\n\n        return licenseServerData;\n    }\n\n    /**\n     * Allows application-specific retrieval of ClearKey keys.\n     *\n     * @param {KeySystem} clearkeyKeySystem They exact ClearKey System to be used\n     * @param {ProtectionData} protData protection data to use for the\n     * request\n     * @param {ArrayBuffer} message the key message from the CDM\n     * @return {ClearKeyKeySet|null} the clear keys associated with\n     * the request or null if no keys can be returned by this function\n     * @memberof module:ProtectionKeyController\n     * @instance\n     */\n    function processClearKeyLicenseRequest(clearkeyKeySystem, protData, message) {\n        try {\n            return clearkeyKeySystem.getClearKeysFromProtectionData(protData, message);\n        } catch (error) {\n            logger.error('Failed to retrieve clearkeys from ProtectionData');\n            return null;\n        }\n    }\n\n    function setProtectionData(protectionDataSet) {\n        var getProtectionData = function (keySystemString) {\n            var protData = null;\n            if (protectionDataSet) {\n                protData = (keySystemString in protectionDataSet) ? protectionDataSet[keySystemString] : null;\n            }\n            return protData;\n        };\n\n        for (var i = 0; i < keySystems.length; i++) {\n            var keySystem = keySystems[i];\n            if (keySystem.hasOwnProperty('init')) {\n                keySystem.init(getProtectionData(keySystem.systemString));\n            }\n        }\n    }\n\n    instance = {\n        initialize: initialize,\n        setProtectionData: setProtectionData,\n        isClearKey: isClearKey,\n        initDataEquals: initDataEquals,\n        getKeySystems: getKeySystems,\n        setKeySystems: setKeySystems,\n        getKeySystemBySystemString: getKeySystemBySystemString,\n        getSupportedKeySystemsFromContentProtection: getSupportedKeySystemsFromContentProtection,\n        getSupportedKeySystems: getSupportedKeySystems,\n        getLicenseServer: getLicenseServer,\n        processClearKeyLicenseRequest: processClearKeyLicenseRequest,\n        setConfig: setConfig\n    };\n\n    return instance;\n}\n\nProtectionKeyController.__dashjs_factory_name = 'ProtectionKeyController';\nexport default dashjs.FactoryMaker.getSingletonFactory(ProtectionKeyController); /* jshint ignore:line */\n"]},"metadata":{},"sourceType":"script"}