{"ast":null,"code":"/* \r\n * Copyright (c) 2016, Pierre-Anthony Lemieux <pal@sandflow.com>\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *\r\n * * Redistributions of source code must retain the above copyright notice, this\r\n *   list of conditions and the following disclaimer.\r\n * * Redistributions in binary form must reproduce the above copyright notice,\r\n *   this list of conditions and the following disclaimer in the documentation\r\n *   and/or other materials provided with the distribution.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\r\n * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\r\n * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\r\n * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE\r\n * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR\r\n * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\r\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\r\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\r\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n * POSSIBILITY OF SUCH DAMAGE.\r\n */\n\n/**\r\n * @module imscHTML\r\n */\n;\n\n(function (imscHTML, imscNames, imscStyles) {\n  /**\r\n   * Function that maps <pre>smpte:background</pre> URIs to URLs resolving to image resource\r\n   * @callback IMGResolver\r\n   * @param {string} <pre>smpte:background</pre> URI\r\n   * @return {string} PNG resource URL\r\n   */\n\n  /**\r\n   * Renders an ISD object (returned by <pre>generateISD()</pre>) into a \r\n   * parent element, that must be attached to the DOM. The ISD will be rendered\r\n   * into a child <pre>div</pre>\r\n   * with heigh and width equal to the clientHeight and clientWidth of the element,\r\n   * unless explicitly specified otherwise by the caller. Images URIs specified \r\n   * by <pre>smpte:background</pre> attributes are mapped to image resource URLs\r\n   * by an <pre>imgResolver</pre> function. The latter takes the value of <code>smpte:background</code>\r\n   * attribute and an <code>img</code> DOM element as input, and is expected to\r\n   * set the <code>src</code> attribute of the <code>img</code> to the absolute URI of the image.\r\n   * <pre>displayForcedOnlyMode</pre> sets the (boolean)\r\n   * value of the IMSC1 displayForcedOnlyMode parameter. The function returns\r\n   * an opaque object that should passed in <code>previousISDState</code> when this function\r\n   * is called for the next ISD, otherwise <code>previousISDState</code> should be set to \r\n   * <code>null</code>.\r\n   * \r\n   * @param {Object} isd ISD to be rendered\r\n   * @param {Object} element Element into which the ISD is rendered\r\n   * @param {?IMGResolver} imgResolver Resolve <pre>smpte:background</pre> URIs into URLs.\r\n   * @param {?number} eheight Height (in pixel) of the child <div>div</div> or null \r\n   *                  to use clientHeight of the parent element\r\n   * @param {?number} ewidth Width (in pixel) of the child <div>div</div> or null\r\n   *                  to use clientWidth of the parent element\r\n   * @param {?boolean} displayForcedOnlyMode Value of the IMSC1 displayForcedOnlyMode parameter,\r\n   *                   or false if null         \r\n   * @param {?module:imscUtils.ErrorHandler} errorHandler Error callback\r\n   * @param {Object} previousISDState State saved during processing of the previous ISD, or null if initial call\r\n   * @param {?boolean} enableRollUp Enables roll-up animations (see CEA 708)\r\n   * @return {Object} ISD state to be provided when this funtion is called for the next ISD\r\n   */\n  imscHTML.render = function (isd, element, imgResolver, eheight, ewidth, displayForcedOnlyMode, errorHandler, previousISDState, enableRollUp) {\n    /* maintain aspect ratio if specified */\n    var height = eheight || element.clientHeight;\n    var width = ewidth || element.clientWidth;\n\n    if (isd.aspectRatio !== null) {\n      var twidth = height * isd.aspectRatio;\n\n      if (twidth > width) {\n        height = Math.round(width / isd.aspectRatio);\n      } else {\n        width = twidth;\n      }\n    }\n\n    var rootcontainer = document.createElement(\"div\");\n    rootcontainer.style.position = \"relative\";\n    rootcontainer.style.width = width + \"px\";\n    rootcontainer.style.height = height + \"px\";\n    rootcontainer.style.margin = \"auto\";\n    rootcontainer.style.top = 0;\n    rootcontainer.style.bottom = 0;\n    rootcontainer.style.left = 0;\n    rootcontainer.style.right = 0;\n    rootcontainer.style.zIndex = 0;\n    var context = {\n      h: height,\n      w: width,\n      regionH: null,\n      regionW: null,\n      imgResolver: imgResolver,\n      displayForcedOnlyMode: displayForcedOnlyMode || false,\n      isd: isd,\n      errorHandler: errorHandler,\n      previousISDState: previousISDState,\n      enableRollUp: enableRollUp || false,\n      currentISDState: {},\n      flg: null,\n\n      /* current fillLineGap value if active, null otherwise */\n      lp: null,\n\n      /* current linePadding value if active, null otherwise */\n      mra: null,\n\n      /* current multiRowAlign value if active, null otherwise */\n      ipd: null,\n\n      /* inline progression direction (lr, rl, tb) */\n      bpd: null,\n\n      /* block progression direction (lr, rl, tb) */\n      ruby: null,\n\n      /* is ruby present in a <p> */\n      textEmphasis: null,\n\n      /* is textEmphasis present in a <p> */\n      rubyReserve: null\n      /* is rubyReserve applicable to a <p> */\n\n    };\n    element.appendChild(rootcontainer);\n\n    if (\"contents\" in isd) {\n      for (var i = 0; i < isd.contents.length; i++) {\n        processElement(context, rootcontainer, isd.contents[i], isd);\n      }\n    }\n\n    return context.currentISDState;\n  };\n\n  function processElement(context, dom_parent, isd_element, isd_parent) {\n    var e;\n\n    if (isd_element.kind === 'region') {\n      e = document.createElement(\"div\");\n      e.style.position = \"absolute\";\n    } else if (isd_element.kind === 'body') {\n      e = document.createElement(\"div\");\n    } else if (isd_element.kind === 'div') {\n      e = document.createElement(\"div\");\n    } else if (isd_element.kind === 'image') {\n      e = document.createElement(\"img\");\n\n      if (context.imgResolver !== null && isd_element.src !== null) {\n        var uri = context.imgResolver(isd_element.src, e);\n        if (uri) e.src = uri;\n        e.height = context.regionH;\n        e.width = context.regionW;\n      }\n    } else if (isd_element.kind === 'p') {\n      e = document.createElement(\"p\");\n    } else if (isd_element.kind === 'span') {\n      if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"container\") {\n        e = document.createElement(\"ruby\");\n        context.ruby = true;\n      } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"base\") {\n        e = document.createElement(\"rb\");\n      } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"text\") {\n        e = document.createElement(\"rt\");\n      } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"baseContainer\") {\n        e = document.createElement(\"rbc\");\n      } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"textContainer\") {\n        e = document.createElement(\"rtc\");\n      } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"delimiter\") {\n        /* ignore rp */\n        return;\n      } else {\n        e = document.createElement(\"span\");\n      } //e.textContent = isd_element.text;\n\n    } else if (isd_element.kind === 'br') {\n      e = document.createElement(\"br\");\n    }\n\n    if (!e) {\n      reportError(context.errorHandler, \"Error processing ISD element kind: \" + isd_element.kind);\n      return;\n    }\n    /* set language */\n\n\n    if (isd_element.lang) {\n      if (isd_element.kind === 'region' || isd_element.lang !== isd_parent.lang) {\n        e.lang = isd_element.lang;\n      }\n    }\n    /* add to parent */\n\n\n    dom_parent.appendChild(e);\n    /* override UA default margin */\n\n    /* TODO: should apply to <p> only */\n\n    e.style.margin = \"0\";\n    /* determine ipd and bpd */\n\n    if (isd_element.kind === \"region\") {\n      var wdir = isd_element.styleAttrs[imscStyles.byName.writingMode.qname];\n\n      if (wdir === \"lrtb\" || wdir === \"lr\") {\n        context.ipd = \"lr\";\n        context.bpd = \"tb\";\n      } else if (wdir === \"rltb\" || wdir === \"rl\") {\n        context.ipd = \"rl\";\n        context.bpd = \"tb\";\n      } else if (wdir === \"tblr\") {\n        context.ipd = \"tb\";\n        context.bpd = \"lr\";\n      } else if (wdir === \"tbrl\" || wdir === \"tb\") {\n        context.ipd = \"tb\";\n        context.bpd = \"rl\";\n      }\n    } else if (isd_element.kind === \"p\" && context.bpd === \"tb\") {\n      var pdir = isd_element.styleAttrs[imscStyles.byName.direction.qname];\n      context.ipd = pdir === \"ltr\" ? \"lr\" : \"rl\";\n    }\n    /* tranform TTML styles to CSS styles */\n\n\n    for (var i = 0; i < STYLING_MAP_DEFS.length; i++) {\n      var sm = STYLING_MAP_DEFS[i];\n      var attr = isd_element.styleAttrs[sm.qname];\n\n      if (attr !== undefined && sm.map !== null) {\n        sm.map(context, e, isd_element, attr);\n      }\n    }\n\n    var proc_e = e;\n    /* do we have linePadding ? */\n\n    var lp = isd_element.styleAttrs[imscStyles.byName.linePadding.qname];\n\n    if (lp && !lp.isZero()) {\n      var plength = lp.toUsedLength(context.w, context.h);\n\n      if (plength > 0) {\n        /* apply padding to the <p> so that line padding does not cause line wraps */\n        var padmeasure = Math.ceil(plength) + \"px\";\n\n        if (context.bpd === \"tb\") {\n          proc_e.style.paddingLeft = padmeasure;\n          proc_e.style.paddingRight = padmeasure;\n        } else {\n          proc_e.style.paddingTop = padmeasure;\n          proc_e.style.paddingBottom = padmeasure;\n        }\n\n        context.lp = lp;\n      }\n    } // do we have multiRowAlign?\n\n\n    var mra = isd_element.styleAttrs[imscStyles.byName.multiRowAlign.qname];\n\n    if (mra && mra !== \"auto\") {\n      /* create inline block to handle multirowAlign */\n      var s = document.createElement(\"span\");\n      s.style.display = \"inline-block\";\n      s.style.textAlign = mra;\n      e.appendChild(s);\n      proc_e = s;\n      context.mra = mra;\n    }\n    /* do we have rubyReserve? */\n\n\n    var rr = isd_element.styleAttrs[imscStyles.byName.rubyReserve.qname];\n\n    if (rr && rr[0] !== \"none\") {\n      context.rubyReserve = rr;\n    }\n    /* remember we are filling line gaps */\n\n\n    if (isd_element.styleAttrs[imscStyles.byName.fillLineGap.qname]) {\n      context.flg = true;\n    }\n\n    if (isd_element.kind === \"span\" && isd_element.text) {\n      var te = isd_element.styleAttrs[imscStyles.byName.textEmphasis.qname];\n\n      if (te && te.style !== \"none\") {\n        context.textEmphasis = true;\n      }\n\n      if (imscStyles.byName.textCombine.qname in isd_element.styleAttrs && isd_element.styleAttrs[imscStyles.byName.textCombine.qname] === \"all\") {\n        /* ignore tate-chu-yoku since line break cannot happen within */\n        e.textContent = isd_element.text;\n\n        if (te) {\n          applyTextEmphasis(context, e, isd_element, te);\n        }\n\n        ;\n      } else {\n        // wrap characters in spans to find the line wrap locations\n        var cbuf = '';\n\n        for (var j = 0; j < isd_element.text.length; j++) {\n          cbuf += isd_element.text.charAt(j);\n          var cc = isd_element.text.charCodeAt(j);\n\n          if (cc < 0xD800 || cc > 0xDBFF || j === isd_element.text.length - 1) {\n            /* wrap the character(s) in a span unless it is a high surrogate */\n            var span = document.createElement(\"span\");\n            span.textContent = cbuf;\n            /* apply textEmphasis */\n\n            if (te) {\n              applyTextEmphasis(context, span, isd_element, te);\n            }\n\n            ;\n            e.appendChild(span);\n            cbuf = ''; //For the sake of merging these back together, record what isd element generated it.\n\n            span._isd_element = isd_element;\n          }\n        }\n      }\n    }\n    /* process the children of the ISD element */\n\n\n    if (\"contents\" in isd_element) {\n      for (var k = 0; k < isd_element.contents.length; k++) {\n        processElement(context, proc_e, isd_element.contents[k], isd_element);\n      }\n    }\n    /* list of lines */\n\n\n    var linelist = [];\n    /* paragraph processing */\n\n    /* TODO: linePadding only supported for horizontal scripts */\n\n    if (isd_element.kind === \"p\") {\n      constructLineList(context, proc_e, linelist, null);\n      /* apply rubyReserve */\n\n      if (context.rubyReserve) {\n        applyRubyReserve(linelist, context);\n        context.rubyReserve = null;\n      }\n      /* apply tts:rubyPosition=\"outside\" */\n\n\n      if (context.ruby || context.rubyReserve) {\n        applyRubyPosition(linelist, context);\n        context.ruby = null;\n      }\n      /* apply text emphasis \"outside\" position */\n\n\n      if (context.textEmphasis) {\n        applyTextEmphasisOutside(linelist, context);\n        context.textEmphasis = null;\n      }\n      /* insert line breaks for multirowalign */\n\n\n      if (context.mra) {\n        applyMultiRowAlign(linelist);\n        context.mra = null;\n      }\n      /* add linepadding */\n\n\n      if (context.lp) {\n        applyLinePadding(linelist, context.lp.toUsedLength(context.w, context.h), context);\n        context.lp = null;\n      }\n\n      mergeSpans(linelist); // The earlier we can do this the less processing there will be.\n\n      /* fill line gaps linepadding */\n\n      if (context.flg) {\n        var par_edges = rect2edges(proc_e.getBoundingClientRect(), context);\n        applyFillLineGap(linelist, par_edges.before, par_edges.after, context, proc_e);\n        context.flg = null;\n      }\n    }\n    /* region processing */\n\n\n    if (isd_element.kind === \"region\") {\n      /* perform roll up if needed */\n      if (context.bpd === \"tb\" && context.enableRollUp && isd_element.contents.length > 0 && isd_element.styleAttrs[imscStyles.byName.displayAlign.qname] === 'after') {\n        /* build line list */\n        constructLineList(context, proc_e, linelist, null);\n        /* horrible hack, perhaps default region id should be underscore everywhere? */\n\n        var rid = isd_element.id === '' ? '_' : isd_element.id;\n        var rb = new RegionPBuffer(rid, linelist);\n        context.currentISDState[rb.id] = rb;\n\n        if (context.previousISDState && rb.id in context.previousISDState && context.previousISDState[rb.id].plist.length > 0 && rb.plist.length > 1 && rb.plist[rb.plist.length - 2].text === context.previousISDState[rb.id].plist[context.previousISDState[rb.id].plist.length - 1].text) {\n          var body_elem = e.firstElementChild;\n          var h = rb.plist[rb.plist.length - 1].after - rb.plist[rb.plist.length - 1].before;\n          body_elem.style.bottom = \"-\" + h + \"px\";\n          body_elem.style.transition = \"transform 0.4s\";\n          body_elem.style.position = \"relative\";\n          body_elem.style.transform = \"translateY(-\" + h + \"px)\";\n        }\n      }\n    }\n  }\n\n  function mergeSpans(lineList) {\n    for (var i = 0; i < lineList.length; i++) {\n      var line = lineList[i];\n\n      for (var j = 1; j < line.elements.length;) {\n        var previous = line.elements[j - 1];\n        var span = line.elements[j];\n\n        if (spanMerge(previous.node, span.node)) {\n          //removed from DOM by spanMerge(), remove from the list too.\n          line.elements.splice(j, 1);\n          continue;\n        } else {\n          j++;\n        }\n      }\n    } // Copy backgroundColor to each span so that fillLineGap will apply padding to elements with the right background\n\n\n    var thisNode, ancestorBackgroundColor;\n    var clearTheseBackgrounds = [];\n\n    for (var l = 0; l < lineList.length; l++) {\n      for (var el = 0; el < lineList[l].elements.length; el++) {\n        thisNode = lineList[l].elements[el].node;\n        ancestorBackgroundColor = getSpanAncestorColor(thisNode, clearTheseBackgrounds, false);\n\n        if (ancestorBackgroundColor) {\n          thisNode.style.backgroundColor = ancestorBackgroundColor;\n        }\n      }\n    }\n\n    for (var bi = 0; bi < clearTheseBackgrounds.length; bi++) {\n      clearTheseBackgrounds[bi].style.backgroundColor = \"\";\n    }\n  }\n\n  function getSpanAncestorColor(element, ancestorList, isAncestor) {\n    if (element.style.backgroundColor) {\n      if (isAncestor && !ancestorList.includes(element)) {\n        ancestorList.push(element);\n      }\n\n      return element.style.backgroundColor;\n    } else {\n      if (element.parentElement.nodeName === \"SPAN\") {\n        return getSpanAncestorColor(element.parentElement, ancestorList, true);\n      }\n    }\n\n    return undefined;\n  }\n\n  function spanMerge(first, second) {\n    if (first.tagName === \"SPAN\" && second.tagName === \"SPAN\" && first._isd_element === second._isd_element) {\n      first.textContent += second.textContent;\n\n      for (var i = 0; i < second.style.length; i++) {\n        var styleName = second.style[i];\n\n        if (styleName.indexOf(\"border\") >= 0 || styleName.indexOf(\"padding\") >= 0 || styleName.indexOf(\"margin\") >= 0) {\n          first.style[styleName] = second.style[styleName];\n        }\n      }\n\n      second.parentElement.removeChild(second);\n      return true;\n    }\n\n    return false;\n  }\n\n  function applyLinePadding(lineList, lp, context) {\n    if (lineList === null) return;\n\n    for (var i = 0; i < lineList.length; i++) {\n      var l = lineList[i].elements.length;\n      var pospadpxlen = Math.ceil(lp) + \"px\";\n      var negpadpxlen = \"-\" + Math.ceil(lp) + \"px\";\n\n      if (l !== 0) {\n        var se = lineList[i].elements[lineList[i].start_elem];\n        var ee = lineList[i].elements[lineList[i].end_elem];\n\n        if (se === ee) {\n          // Check to see if there's any background at all\n          elementBoundingRect = se.node.getBoundingClientRect();\n\n          if (elementBoundingRect.width == 0 || elementBoundingRect.height == 0) {\n            // There's no background on this line, move on.\n            continue;\n          }\n        } // Start element\n\n\n        if (context.ipd === \"lr\") {\n          se.node.style.marginLeft = negpadpxlen;\n          se.node.style.paddingLeft = pospadpxlen;\n        } else if (context.ipd === \"rl\") {\n          se.node.style.paddingRight = pospadpxlen;\n          se.node.style.marginRight = negpadpxlen;\n        } else if (context.ipd === \"tb\") {\n          se.node.style.paddingTop = pospadpxlen;\n          se.node.style.marginTop = negpadpxlen;\n        } // End element\n\n\n        if (context.ipd === \"lr\") {\n          ee.node.style.marginRight = negpadpxlen;\n          ee.node.style.paddingRight = pospadpxlen;\n        } else if (context.ipd === \"rl\") {\n          ee.node.style.paddingLeft = pospadpxlen;\n          ee.node.style.marginLeft = negpadpxlen;\n        } else if (context.ipd === \"tb\") {\n          ee.node.style.paddingBottom = pospadpxlen;\n          ee.node.style.marginBottom = negpadpxlen;\n        }\n      }\n    }\n  }\n\n  function applyMultiRowAlign(lineList) {\n    /* apply an explicit br to all but the last line */\n    for (var i = 0; i < lineList.length - 1; i++) {\n      var l = lineList[i].elements.length;\n\n      if (l !== 0 && lineList[i].br === false) {\n        var br = document.createElement(\"br\");\n        var lastnode = lineList[i].elements[l - 1].node;\n        lastnode.parentElement.insertBefore(br, lastnode.nextSibling);\n      }\n    }\n  }\n\n  function applyTextEmphasisOutside(lineList, context) {\n    /* supports \"outside\" only */\n    for (var i = 0; i < lineList.length; i++) {\n      for (var j = 0; j < lineList[i].te.length; j++) {\n        /* skip if position already set */\n        if (lineList[i].te[j].style[TEXTEMPHASISPOSITION_PROP] && lineList[i].te[j].style[TEXTEMPHASISPOSITION_PROP] !== \"none\") continue;\n        var pos;\n\n        if (context.bpd === \"tb\") {\n          pos = i === 0 ? \"left over\" : \"left under\";\n        } else {\n          if (context.bpd === \"rl\") {\n            pos = i === 0 ? \"right under\" : \"left under\";\n          } else {\n            pos = i === 0 ? \"left under\" : \"right under\";\n          }\n        }\n\n        lineList[i].te[j].style[TEXTEMPHASISPOSITION_PROP] = pos;\n      }\n    }\n  }\n\n  function applyRubyPosition(lineList, context) {\n    for (var i = 0; i < lineList.length; i++) {\n      for (var j = 0; j < lineList[i].rbc.length; j++) {\n        /* skip if ruby-position already set */\n        if (lineList[i].rbc[j].style[RUBYPOSITION_PROP]) continue;\n        var pos;\n\n        if (RUBYPOSITION_ISWK) {\n          /* WebKit exception */\n          pos = i === 0 ? \"before\" : \"after\";\n        } else if (context.bpd === \"tb\") {\n          pos = i === 0 ? \"over\" : \"under\";\n        } else {\n          if (context.bpd === \"rl\") {\n            pos = i === 0 ? \"over\" : \"under\";\n          } else {\n            pos = i === 0 ? \"under\" : \"over\";\n          }\n        }\n\n        lineList[i].rbc[j].style[RUBYPOSITION_PROP] = pos;\n      }\n    }\n  }\n\n  function applyRubyReserve(lineList, context) {\n    for (var i = 0; i < lineList.length; i++) {\n      var ruby = document.createElement(\"ruby\");\n      var rb = document.createElement(\"rb\");\n      rb.textContent = \"\\u200B\";\n      ruby.appendChild(rb);\n      var rt1;\n      var rt2;\n      var fs = context.rubyReserve[1].toUsedLength(context.w, context.h) + \"px\";\n\n      if (context.rubyReserve[0] === \"both\" || context.rubyReserve[0] === \"outside\" && lineList.length == 1) {\n        rt1 = document.createElement(\"rtc\");\n        rt1.style[RUBYPOSITION_PROP] = RUBYPOSITION_ISWK ? \"after\" : \"under\";\n        rt1.textContent = \"\\u200B\";\n        rt1.style.fontSize = fs;\n        rt2 = document.createElement(\"rtc\");\n        rt2.style[RUBYPOSITION_PROP] = RUBYPOSITION_ISWK ? \"before\" : \"over\";\n        rt2.textContent = \"\\u200B\";\n        rt2.style.fontSize = fs;\n        ruby.appendChild(rt1);\n        ruby.appendChild(rt2);\n      } else {\n        rt1 = document.createElement(\"rtc\");\n        rt1.textContent = \"\\u200B\";\n        rt1.style.fontSize = fs;\n        var pos;\n\n        if (context.rubyReserve[0] === \"after\" || context.rubyReserve[0] === \"outside\" && i > 0) {\n          pos = RUBYPOSITION_ISWK ? \"after\" : context.bpd === \"tb\" || context.bpd === \"rl\" ? \"under\" : \"over\";\n        } else {\n          pos = RUBYPOSITION_ISWK ? \"before\" : context.bpd === \"tb\" || context.bpd === \"rl\" ? \"over\" : \"under\";\n        }\n\n        rt1.style[RUBYPOSITION_PROP] = pos;\n        ruby.appendChild(rt1);\n      }\n      /* add in front of the first ruby element of the line, if it exists */\n\n\n      var sib = null;\n\n      for (var j = 0; j < lineList[i].rbc.length; j++) {\n        if (lineList[i].rbc[j].localName === 'ruby') {\n          sib = lineList[i].rbc[j];\n          /* copy specified style properties from the sibling ruby container */\n\n          for (var k = 0; k < sib.style.length; k++) {\n            ruby.style.setProperty(sib.style.item(k), sib.style.getPropertyValue(sib.style.item(k)));\n          }\n\n          break;\n        }\n      }\n      /* otherwise add before first span */\n\n\n      sib = sib || lineList[i].elements[0].node;\n      sib.parentElement.insertBefore(ruby, sib);\n    }\n  }\n\n  function applyFillLineGap(lineList, par_before, par_after, context, element) {\n    /* positive for BPD = lr and tb, negative for BPD = rl */\n    var s = Math.sign(par_after - par_before);\n\n    for (var i = 0; i <= lineList.length; i++) {\n      /* compute frontier between lines */\n      var frontier;\n\n      if (i === 0) {\n        frontier = Math.round(par_before);\n      } else if (i === lineList.length) {\n        frontier = Math.round(par_after);\n      } else {\n        frontier = Math.round((lineList[i - 1].after + lineList[i].before) / 2);\n      }\n\n      var padding;\n      var l, thisNode;\n      /* before line */\n\n      if (i > 0) {\n        if (lineList[i - 1]) {\n          for (l = 0; l < lineList[i - 1].elements.length; l++) {\n            thisNode = lineList[i - 1].elements[l];\n            padding = s * (frontier - thisNode.after) + \"px\";\n\n            if (context.bpd === \"lr\") {\n              thisNode.node.style.paddingRight = padding;\n            } else if (context.bpd === \"rl\") {\n              thisNode.node.style.paddingLeft = padding;\n            } else if (context.bpd === \"tb\") {\n              thisNode.node.style.paddingBottom = padding;\n            }\n          }\n        }\n      }\n      /* after line */\n\n\n      if (i < lineList.length) {\n        for (l = 0; l < lineList[i].elements.length; l++) {\n          thisNode = lineList[i].elements[l];\n          padding = s * (thisNode.before - frontier) + \"px\";\n\n          if (context.bpd === \"lr\") {\n            thisNode.node.style.paddingLeft = padding;\n          } else if (context.bpd === \"rl\") {\n            thisNode.node.style.paddingRight = padding;\n          } else if (context.bpd === \"tb\") {\n            thisNode.node.style.paddingTop = padding;\n          }\n        }\n      }\n    }\n  }\n\n  function RegionPBuffer(id, lineList) {\n    this.id = id;\n    this.plist = lineList;\n  }\n\n  function rect2edges(rect, context) {\n    var edges = {\n      before: null,\n      after: null,\n      start: null,\n      end: null\n    };\n\n    if (context.bpd === \"tb\") {\n      edges.before = rect.top;\n      edges.after = rect.bottom;\n\n      if (context.ipd === \"lr\") {\n        edges.start = rect.left;\n        edges.end = rect.right;\n      } else {\n        edges.start = rect.right;\n        edges.end = rect.left;\n      }\n    } else if (context.bpd === \"lr\") {\n      edges.before = rect.left;\n      edges.after = rect.right;\n      edges.start = rect.top;\n      edges.end = rect.bottom;\n    } else if (context.bpd === \"rl\") {\n      edges.before = rect.right;\n      edges.after = rect.left;\n      edges.start = rect.top;\n      edges.end = rect.bottom;\n    }\n\n    return edges;\n  }\n\n  function constructLineList(context, element, llist, bgcolor) {\n    if (element.localName === \"rt\" || element.localName === \"rtc\") {\n      /* skip ruby annotations */\n      return;\n    }\n\n    var curbgcolor = element.style.backgroundColor || bgcolor;\n\n    if (element.childElementCount === 0) {\n      if (element.localName === 'span' || element.localName === 'rb') {\n        var r = element.getBoundingClientRect();\n        var edges = rect2edges(r, context);\n\n        if (llist.length === 0 || !isSameLine(edges.before, edges.after, llist[llist.length - 1].before, llist[llist.length - 1].after)) {\n          llist.push({\n            before: edges.before,\n            after: edges.after,\n            start: edges.start,\n            end: edges.end,\n            start_elem: 0,\n            end_elem: 0,\n            elements: [],\n            rbc: [],\n            te: [],\n            text: \"\",\n            br: false\n          });\n        } else {\n          /* positive for BPD = lr and tb, negative for BPD = rl */\n          var bpd_dir = Math.sign(edges.after - edges.before);\n          /* positive for IPD = lr and tb, negative for IPD = rl */\n\n          var ipd_dir = Math.sign(edges.end - edges.start);\n          /* check if the line height has increased */\n\n          if (bpd_dir * (edges.before - llist[llist.length - 1].before) < 0) {\n            llist[llist.length - 1].before = edges.before;\n          }\n\n          if (bpd_dir * (edges.after - llist[llist.length - 1].after) > 0) {\n            llist[llist.length - 1].after = edges.after;\n          }\n\n          if (ipd_dir * (edges.start - llist[llist.length - 1].start) < 0) {\n            llist[llist.length - 1].start = edges.start;\n            llist[llist.length - 1].start_elem = llist[llist.length - 1].elements.length;\n          }\n\n          if (ipd_dir * (edges.end - llist[llist.length - 1].end) > 0) {\n            llist[llist.length - 1].end = edges.end;\n            llist[llist.length - 1].end_elem = llist[llist.length - 1].elements.length;\n          }\n        }\n\n        llist[llist.length - 1].text += element.textContent;\n        llist[llist.length - 1].elements.push({\n          node: element,\n          bgcolor: curbgcolor,\n          before: edges.before,\n          after: edges.after\n        });\n      } else if (element.localName === 'br' && llist.length !== 0) {\n        llist[llist.length - 1].br = true;\n      }\n    } else {\n      var child = element.firstChild;\n\n      while (child) {\n        if (child.nodeType === Node.ELEMENT_NODE) {\n          constructLineList(context, child, llist, curbgcolor);\n\n          if (child.localName === 'ruby' || child.localName === 'rtc') {\n            /* remember non-empty ruby and rtc elements so that tts:rubyPosition can be applied */\n            if (llist.length > 0) {\n              llist[llist.length - 1].rbc.push(child);\n            }\n          } else if (child.localName === 'span' && child.style[TEXTEMPHASISSTYLE_PROP] && child.style[TEXTEMPHASISSTYLE_PROP] !== \"none\") {\n            /* remember non-empty span elements with textEmphasis */\n            if (llist.length > 0) {\n              llist[llist.length - 1].te.push(child);\n            }\n          }\n        }\n\n        child = child.nextSibling;\n      }\n    }\n  }\n\n  function isSameLine(before1, after1, before2, after2) {\n    return after1 < after2 && before1 > before2 || after2 <= after1 && before2 >= before1;\n  }\n\n  function applyTextEmphasis(context, dom_element, isd_element, attr) {\n    /* ignore color (not used in IMSC 1.1) */\n    if (attr.style === \"none\") {\n      /* text-emphasis is not inherited and the default is none, so nothing to do */\n      return;\n    } else if (attr.style === \"auto\") {\n      dom_element.style[TEXTEMPHASISSTYLE_PROP] = \"filled\";\n    } else {\n      dom_element.style[TEXTEMPHASISSTYLE_PROP] = attr.style + \" \" + attr.symbol;\n    }\n    /* ignore \"outside\" position (set in postprocessing) */\n\n\n    if (attr.position === \"before\" || attr.position === \"after\") {\n      var pos;\n\n      if (context.bpd === \"tb\") {\n        pos = attr.position === \"before\" ? \"left over\" : \"left under\";\n      } else {\n        if (context.bpd === \"rl\") {\n          pos = attr.position === \"before\" ? \"right under\" : \"left under\";\n        } else {\n          pos = attr.position === \"before\" ? \"left under\" : \"right under\";\n        }\n      }\n\n      dom_element.style[TEXTEMPHASISPOSITION_PROP] = pos;\n    }\n  }\n\n  function HTMLStylingMapDefinition(qName, mapFunc) {\n    this.qname = qName;\n    this.map = mapFunc;\n  }\n\n  var STYLING_MAP_DEFS = [new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling backgroundColor\", function (context, dom_element, isd_element, attr) {\n    /* skip if transparent */\n    if (attr[3] === 0) return;\n    dom_element.style.backgroundColor = \"rgba(\" + attr[0].toString() + \",\" + attr[1].toString() + \",\" + attr[2].toString() + \",\" + (attr[3] / 255).toString() + \")\";\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling color\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.color = \"rgba(\" + attr[0].toString() + \",\" + attr[1].toString() + \",\" + attr[2].toString() + \",\" + (attr[3] / 255).toString() + \")\";\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling direction\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.direction = attr;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling display\", function (context, dom_element, isd_element, attr) {}), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling displayAlign\", function (context, dom_element, isd_element, attr) {\n    /* see https://css-tricks.com/snippets/css/a-guide-to-flexbox/ */\n\n    /* TODO: is this affected by writing direction? */\n    dom_element.style.display = \"flex\";\n    dom_element.style.flexDirection = \"column\";\n\n    if (attr === \"before\") {\n      dom_element.style.justifyContent = \"flex-start\";\n    } else if (attr === \"center\") {\n      dom_element.style.justifyContent = \"center\";\n    } else if (attr === \"after\") {\n      dom_element.style.justifyContent = \"flex-end\";\n    }\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling extent\", function (context, dom_element, isd_element, attr) {\n    /* TODO: this is super ugly */\n    context.regionH = attr.h.toUsedLength(context.w, context.h);\n    context.regionW = attr.w.toUsedLength(context.w, context.h);\n    /* \r\n     * CSS height/width are measured against the content rectangle,\r\n     * whereas TTML height/width include padding\r\n     */\n\n    var hdelta = 0;\n    var wdelta = 0;\n    var p = isd_element.styleAttrs[\"http://www.w3.org/ns/ttml#styling padding\"];\n\n    if (!p) {\n      /* error */\n    } else {\n      hdelta = p[0].toUsedLength(context.w, context.h) + p[2].toUsedLength(context.w, context.h);\n      wdelta = p[1].toUsedLength(context.w, context.h) + p[3].toUsedLength(context.w, context.h);\n    }\n\n    dom_element.style.height = context.regionH - hdelta + \"px\";\n    dom_element.style.width = context.regionW - wdelta + \"px\";\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling fontFamily\", function (context, dom_element, isd_element, attr) {\n    var rslt = [];\n    /* per IMSC1 */\n\n    for (var i = 0; i < attr.length; i++) {\n      if (attr[i] === \"monospaceSerif\") {\n        rslt.push(\"Courier New\");\n        rslt.push('\"Liberation Mono\"');\n        rslt.push(\"Courier\");\n        rslt.push(\"monospace\");\n      } else if (attr[i] === \"proportionalSansSerif\") {\n        rslt.push(\"Arial\");\n        rslt.push(\"Helvetica\");\n        rslt.push('\"Liberation Sans\"');\n        rslt.push(\"sans-serif\");\n      } else if (attr[i] === \"monospace\") {\n        rslt.push(\"monospace\");\n      } else if (attr[i] === \"sansSerif\") {\n        rslt.push(\"sans-serif\");\n      } else if (attr[i] === \"serif\") {\n        rslt.push(\"serif\");\n      } else if (attr[i] === \"monospaceSansSerif\") {\n        rslt.push(\"Consolas\");\n        rslt.push(\"monospace\");\n      } else if (attr[i] === \"proportionalSerif\") {\n        rslt.push(\"serif\");\n      } else {\n        rslt.push(attr[i]);\n      }\n    } // prune later duplicates we may have inserted \n\n\n    if (rslt.length > 0) {\n      var unique = [rslt[0]];\n\n      for (var fi = 1; fi < rslt.length; fi++) {\n        if (unique.indexOf(rslt[fi]) == -1) {\n          unique.push(rslt[fi]);\n        }\n      }\n\n      rslt = unique;\n    }\n\n    dom_element.style.fontFamily = rslt.join(\",\");\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling shear\", function (context, dom_element, isd_element, attr) {\n    /* return immediately if tts:shear is 0% since CSS transforms are not inherited*/\n    if (attr === 0) return;\n    var angle = attr * -0.9;\n    /* context.bpd is needed since writing mode is not inherited and sets the inline progression */\n\n    if (context.bpd === \"tb\") {\n      dom_element.style.transform = \"skewX(\" + angle + \"deg)\";\n    } else {\n      dom_element.style.transform = \"skewY(\" + angle + \"deg)\";\n    }\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling fontSize\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.fontSize = attr.toUsedLength(context.w, context.h) + \"px\";\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling fontStyle\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.fontStyle = attr;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling fontWeight\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.fontWeight = attr;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling lineHeight\", function (context, dom_element, isd_element, attr) {\n    if (attr === \"normal\") {\n      dom_element.style.lineHeight = \"normal\";\n    } else {\n      dom_element.style.lineHeight = attr.toUsedLength(context.w, context.h) + \"px\";\n    }\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling opacity\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.opacity = attr;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling origin\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.top = attr.h.toUsedLength(context.w, context.h) + \"px\";\n    dom_element.style.left = attr.w.toUsedLength(context.w, context.h) + \"px\";\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling overflow\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.overflow = attr;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling padding\", function (context, dom_element, isd_element, attr) {\n    /* attr: top,left,bottom,right*/\n\n    /* style: top right bottom left*/\n    var rslt = [];\n    rslt[0] = attr[0].toUsedLength(context.w, context.h) + \"px\";\n    rslt[1] = attr[3].toUsedLength(context.w, context.h) + \"px\";\n    rslt[2] = attr[2].toUsedLength(context.w, context.h) + \"px\";\n    rslt[3] = attr[1].toUsedLength(context.w, context.h) + \"px\";\n    dom_element.style.padding = rslt.join(\" \");\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling position\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.top = attr.h.toUsedLength(context.w, context.h) + \"px\";\n    dom_element.style.left = attr.w.toUsedLength(context.w, context.h) + \"px\";\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling rubyAlign\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.rubyAlign = attr === \"spaceAround\" ? \"space-around\" : \"center\";\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling rubyPosition\", function (context, dom_element, isd_element, attr) {\n    /* skip if \"outside\", which is handled by applyRubyPosition() */\n    if (attr === \"before\" || attr === \"after\") {\n      var pos;\n\n      if (RUBYPOSITION_ISWK) {\n        /* WebKit exception */\n        pos = attr;\n      } else if (context.bpd === \"tb\") {\n        pos = attr === \"before\" ? \"over\" : \"under\";\n      } else {\n        if (context.bpd === \"rl\") {\n          pos = attr === \"before\" ? \"over\" : \"under\";\n        } else {\n          pos = attr === \"before\" ? \"under\" : \"over\";\n        }\n      }\n      /* apply position to the parent dom_element, i.e. ruby or rtc */\n\n\n      dom_element.parentElement.style[RUBYPOSITION_PROP] = pos;\n    }\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling showBackground\", null), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling textAlign\", function (context, dom_element, isd_element, attr) {\n    var ta;\n    /* handle UAs that do not understand start or end */\n\n    if (attr === \"start\") {\n      ta = context.ipd === \"rl\" ? \"right\" : \"left\";\n    } else if (attr === \"end\") {\n      ta = context.ipd === \"rl\" ? \"left\" : \"right\";\n    } else {\n      ta = attr;\n    }\n\n    dom_element.style.textAlign = ta;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling textDecoration\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.textDecoration = attr.join(\" \").replace(\"lineThrough\", \"line-through\");\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling textOutline\", function (context, dom_element, isd_element, attr) {\n    /* defer to tts:textShadow */\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling textShadow\", function (context, dom_element, isd_element, attr) {\n    var txto = isd_element.styleAttrs[imscStyles.byName.textOutline.qname];\n\n    if (attr === \"none\" && txto === \"none\") {\n      dom_element.style.textShadow = \"\";\n    } else {\n      var s = [];\n\n      if (txto !== \"none\") {\n        /* emulate text outline */\n        var to_color = \"rgba(\" + txto.color[0].toString() + \",\" + txto.color[1].toString() + \",\" + txto.color[2].toString() + \",\" + (txto.color[3] / 255).toString() + \")\";\n        s.push(\"1px 1px 1px \" + to_color);\n        s.push(\"-1px 1px 1px \" + to_color);\n        s.push(\"1px -1px 1px \" + to_color);\n        s.push(\"-1px -1px 1px \" + to_color);\n      }\n      /* add text shadow */\n\n\n      if (attr !== \"none\") {\n        for (var i = 0; i < attr.length; i++) {\n          s.push(attr[i].x_off.toUsedLength(context.w, context.h) + \"px \" + attr[i].y_off.toUsedLength(context.w, context.h) + \"px \" + attr[i].b_radius.toUsedLength(context.w, context.h) + \"px \" + \"rgba(\" + attr[i].color[0].toString() + \",\" + attr[i].color[1].toString() + \",\" + attr[i].color[2].toString() + \",\" + (attr[i].color[3] / 255).toString() + \")\");\n        }\n      }\n\n      dom_element.style.textShadow = s.join(\",\");\n    }\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling textCombine\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.textCombineUpright = attr;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling textEmphasis\", function (context, dom_element, isd_element, attr) {\n    /* applied as part of HTML document construction */\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling unicodeBidi\", function (context, dom_element, isd_element, attr) {\n    var ub;\n\n    if (attr === 'bidiOverride') {\n      ub = \"bidi-override\";\n    } else {\n      ub = attr;\n    }\n\n    dom_element.style.unicodeBidi = ub;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling visibility\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.visibility = attr;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling wrapOption\", function (context, dom_element, isd_element, attr) {\n    if (attr === \"wrap\") {\n      if (isd_element.space === \"preserve\") {\n        dom_element.style.whiteSpace = \"pre-wrap\";\n      } else {\n        dom_element.style.whiteSpace = \"normal\";\n      }\n    } else {\n      if (isd_element.space === \"preserve\") {\n        dom_element.style.whiteSpace = \"pre\";\n      } else {\n        dom_element.style.whiteSpace = \"noWrap\";\n      }\n    }\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling writingMode\", function (context, dom_element, isd_element, attr) {\n    var wm;\n\n    if (attr === \"lrtb\" || attr === \"lr\") {\n      dom_element.style.writingMode = \"horizontal-tb\";\n    } else if (attr === \"rltb\" || attr === \"rl\") {\n      dom_element.style.writingMode = \"horizontal-tb\";\n    } else if (attr === \"tblr\") {\n      dom_element.style.writingMode = \"vertical-lr\";\n    } else if (attr === \"tbrl\" || attr === \"tb\") {\n      dom_element.style.writingMode = \"vertical-rl\";\n    }\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml#styling zIndex\", function (context, dom_element, isd_element, attr) {\n    dom_element.style.zIndex = attr;\n  }), new HTMLStylingMapDefinition(\"http://www.w3.org/ns/ttml/profile/imsc1#styling forcedDisplay\", function (context, dom_element, isd_element, attr) {\n    if (context.displayForcedOnlyMode && attr === false) {\n      dom_element.style.visibility = \"hidden\";\n    }\n  })];\n  var STYLMAP_BY_QNAME = {};\n\n  for (var i = 0; i < STYLING_MAP_DEFS.length; i++) {\n    STYLMAP_BY_QNAME[STYLING_MAP_DEFS[i].qname] = STYLING_MAP_DEFS[i];\n  }\n  /* CSS property names */\n\n\n  var RUBYPOSITION_ISWK = (\"webkitRubyPosition\" in window.getComputedStyle(document.documentElement));\n  var RUBYPOSITION_PROP = RUBYPOSITION_ISWK ? \"webkitRubyPosition\" : \"rubyPosition\";\n  var TEXTEMPHASISSTYLE_PROP = \"webkitTextEmphasisStyle\" in window.getComputedStyle(document.documentElement) ? \"webkitTextEmphasisStyle\" : \"textEmphasisStyle\";\n  var TEXTEMPHASISPOSITION_PROP = \"webkitTextEmphasisPosition\" in window.getComputedStyle(document.documentElement) ? \"webkitTextEmphasisPosition\" : \"textEmphasisPosition\";\n  /* error utilities */\n\n  function reportError(errorHandler, msg) {\n    if (errorHandler && errorHandler.error && errorHandler.error(msg)) throw msg;\n  }\n})(typeof exports === 'undefined' ? this.imscHTML = {} : exports, typeof imscNames === 'undefined' ? require(\"./names\") : imscNames, typeof imscStyles === 'undefined' ? require(\"./styles\") : imscStyles, typeof imscUtils === 'undefined' ? require(\"./utils\") : imscUtils);","map":{"version":3,"names":["imscHTML","imscNames","imscStyles","render","isd","element","imgResolver","eheight","ewidth","displayForcedOnlyMode","errorHandler","previousISDState","enableRollUp","height","clientHeight","width","clientWidth","aspectRatio","twidth","Math","round","rootcontainer","document","createElement","style","position","margin","top","bottom","left","right","zIndex","context","h","w","regionH","regionW","currentISDState","flg","lp","mra","ipd","bpd","ruby","textEmphasis","rubyReserve","appendChild","i","contents","length","processElement","dom_parent","isd_element","isd_parent","e","kind","src","uri","styleAttrs","byName","qname","reportError","lang","wdir","writingMode","pdir","direction","STYLING_MAP_DEFS","sm","attr","undefined","map","proc_e","linePadding","isZero","plength","toUsedLength","padmeasure","ceil","paddingLeft","paddingRight","paddingTop","paddingBottom","multiRowAlign","s","display","textAlign","rr","fillLineGap","text","te","textCombine","textContent","applyTextEmphasis","cbuf","j","charAt","cc","charCodeAt","span","_isd_element","k","linelist","constructLineList","applyRubyReserve","applyRubyPosition","applyTextEmphasisOutside","applyMultiRowAlign","applyLinePadding","mergeSpans","par_edges","rect2edges","getBoundingClientRect","applyFillLineGap","before","after","displayAlign","rid","id","rb","RegionPBuffer","plist","body_elem","firstElementChild","transition","transform","lineList","line","elements","previous","spanMerge","node","splice","thisNode","ancestorBackgroundColor","clearTheseBackgrounds","l","el","getSpanAncestorColor","backgroundColor","bi","ancestorList","isAncestor","includes","push","parentElement","nodeName","first","second","tagName","styleName","indexOf","removeChild","pospadpxlen","negpadpxlen","se","start_elem","ee","end_elem","elementBoundingRect","marginLeft","marginRight","marginTop","marginBottom","br","lastnode","insertBefore","nextSibling","TEXTEMPHASISPOSITION_PROP","pos","rbc","RUBYPOSITION_PROP","RUBYPOSITION_ISWK","rt1","rt2","fs","fontSize","sib","localName","setProperty","item","getPropertyValue","par_before","par_after","sign","frontier","padding","rect","edges","start","end","llist","bgcolor","curbgcolor","childElementCount","r","isSameLine","bpd_dir","ipd_dir","child","firstChild","nodeType","Node","ELEMENT_NODE","TEXTEMPHASISSTYLE_PROP","before1","after1","before2","after2","dom_element","symbol","HTMLStylingMapDefinition","qName","mapFunc","toString","color","flexDirection","justifyContent","hdelta","wdelta","p","rslt","unique","fi","fontFamily","join","angle","fontStyle","fontWeight","lineHeight","opacity","overflow","rubyAlign","ta","textDecoration","replace","txto","textOutline","textShadow","to_color","x_off","y_off","b_radius","textCombineUpright","ub","unicodeBidi","visibility","space","whiteSpace","wm","STYLMAP_BY_QNAME","window","getComputedStyle","documentElement","msg","error","exports","require","imscUtils"],"sources":["/home/landsys/react-node-video-streaming/client/node_modules/imsc/src/main/js/html.js"],"sourcesContent":["/* \r\n * Copyright (c) 2016, Pierre-Anthony Lemieux <pal@sandflow.com>\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *\r\n * * Redistributions of source code must retain the above copyright notice, this\r\n *   list of conditions and the following disclaimer.\r\n * * Redistributions in binary form must reproduce the above copyright notice,\r\n *   this list of conditions and the following disclaimer in the documentation\r\n *   and/or other materials provided with the distribution.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\r\n * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\r\n * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\r\n * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE\r\n * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR\r\n * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\r\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\r\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\r\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n * POSSIBILITY OF SUCH DAMAGE.\r\n */\r\n\r\n/**\r\n * @module imscHTML\r\n */\r\n\r\n;\r\n(function (imscHTML, imscNames, imscStyles) {\r\n\r\n    /**\r\n     * Function that maps <pre>smpte:background</pre> URIs to URLs resolving to image resource\r\n     * @callback IMGResolver\r\n     * @param {string} <pre>smpte:background</pre> URI\r\n     * @return {string} PNG resource URL\r\n     */\r\n\r\n\r\n    /**\r\n     * Renders an ISD object (returned by <pre>generateISD()</pre>) into a \r\n     * parent element, that must be attached to the DOM. The ISD will be rendered\r\n     * into a child <pre>div</pre>\r\n     * with heigh and width equal to the clientHeight and clientWidth of the element,\r\n     * unless explicitly specified otherwise by the caller. Images URIs specified \r\n     * by <pre>smpte:background</pre> attributes are mapped to image resource URLs\r\n     * by an <pre>imgResolver</pre> function. The latter takes the value of <code>smpte:background</code>\r\n     * attribute and an <code>img</code> DOM element as input, and is expected to\r\n     * set the <code>src</code> attribute of the <code>img</code> to the absolute URI of the image.\r\n     * <pre>displayForcedOnlyMode</pre> sets the (boolean)\r\n     * value of the IMSC1 displayForcedOnlyMode parameter. The function returns\r\n     * an opaque object that should passed in <code>previousISDState</code> when this function\r\n     * is called for the next ISD, otherwise <code>previousISDState</code> should be set to \r\n     * <code>null</code>.\r\n     * \r\n     * @param {Object} isd ISD to be rendered\r\n     * @param {Object} element Element into which the ISD is rendered\r\n     * @param {?IMGResolver} imgResolver Resolve <pre>smpte:background</pre> URIs into URLs.\r\n     * @param {?number} eheight Height (in pixel) of the child <div>div</div> or null \r\n     *                  to use clientHeight of the parent element\r\n     * @param {?number} ewidth Width (in pixel) of the child <div>div</div> or null\r\n     *                  to use clientWidth of the parent element\r\n     * @param {?boolean} displayForcedOnlyMode Value of the IMSC1 displayForcedOnlyMode parameter,\r\n     *                   or false if null         \r\n     * @param {?module:imscUtils.ErrorHandler} errorHandler Error callback\r\n     * @param {Object} previousISDState State saved during processing of the previous ISD, or null if initial call\r\n     * @param {?boolean} enableRollUp Enables roll-up animations (see CEA 708)\r\n     * @return {Object} ISD state to be provided when this funtion is called for the next ISD\r\n     */\r\n\r\n    imscHTML.render = function (isd,\r\n            element,\r\n            imgResolver,\r\n            eheight,\r\n            ewidth,\r\n            displayForcedOnlyMode,\r\n            errorHandler,\r\n            previousISDState,\r\n            enableRollUp\r\n            ) {\r\n\r\n        /* maintain aspect ratio if specified */\r\n\r\n        var height = eheight || element.clientHeight;\r\n        var width = ewidth || element.clientWidth;\r\n\r\n        if (isd.aspectRatio !== null) {\r\n\r\n            var twidth = height * isd.aspectRatio;\r\n\r\n            if (twidth > width) {\r\n\r\n                height = Math.round(width / isd.aspectRatio);\r\n\r\n            } else {\r\n\r\n                width = twidth;\r\n\r\n            }\r\n\r\n        }\r\n\r\n        var rootcontainer = document.createElement(\"div\");\r\n\r\n        rootcontainer.style.position = \"relative\";\r\n        rootcontainer.style.width = width + \"px\";\r\n        rootcontainer.style.height = height + \"px\";\r\n        rootcontainer.style.margin = \"auto\";\r\n        rootcontainer.style.top = 0;\r\n        rootcontainer.style.bottom = 0;\r\n        rootcontainer.style.left = 0;\r\n        rootcontainer.style.right = 0;\r\n        rootcontainer.style.zIndex = 0;\r\n\r\n        var context = {\r\n            h: height,\r\n            w: width,\r\n            regionH: null,\r\n            regionW: null,\r\n            imgResolver: imgResolver,\r\n            displayForcedOnlyMode: displayForcedOnlyMode || false,\r\n            isd: isd,\r\n            errorHandler: errorHandler,\r\n            previousISDState: previousISDState,\r\n            enableRollUp: enableRollUp || false,\r\n            currentISDState: {},\r\n            flg: null, /* current fillLineGap value if active, null otherwise */\r\n            lp: null, /* current linePadding value if active, null otherwise */\r\n            mra: null, /* current multiRowAlign value if active, null otherwise */\r\n            ipd: null, /* inline progression direction (lr, rl, tb) */\r\n            bpd: null, /* block progression direction (lr, rl, tb) */\r\n            ruby: null, /* is ruby present in a <p> */\r\n            textEmphasis: null, /* is textEmphasis present in a <p> */\r\n            rubyReserve: null /* is rubyReserve applicable to a <p> */\r\n        };\r\n\r\n        element.appendChild(rootcontainer);\r\n\r\n        if (\"contents\" in isd) {\r\n\r\n            for (var i = 0; i < isd.contents.length; i++) {\r\n\r\n                processElement(context, rootcontainer, isd.contents[i], isd);\r\n\r\n            }\r\n\r\n        }\r\n\r\n        return context.currentISDState;\r\n\r\n    };\r\n\r\n    function processElement(context, dom_parent, isd_element, isd_parent) {\r\n\r\n        var e;\r\n\r\n        if (isd_element.kind === 'region') {\r\n\r\n            e = document.createElement(\"div\");\r\n            e.style.position = \"absolute\";\r\n\r\n        } else if (isd_element.kind === 'body') {\r\n\r\n            e = document.createElement(\"div\");\r\n\r\n        } else if (isd_element.kind === 'div') {\r\n\r\n            e = document.createElement(\"div\");\r\n\r\n        } else if (isd_element.kind === 'image') {\r\n\r\n            e = document.createElement(\"img\");\r\n\r\n            if (context.imgResolver !== null && isd_element.src !== null) {\r\n\r\n                var uri = context.imgResolver(isd_element.src, e);\r\n\r\n                if (uri)\r\n                    e.src = uri;\r\n\r\n                e.height = context.regionH;\r\n                e.width = context.regionW;\r\n\r\n            }\r\n\r\n        } else if (isd_element.kind === 'p') {\r\n\r\n            e = document.createElement(\"p\");\r\n\r\n        } else if (isd_element.kind === 'span') {\r\n\r\n            if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"container\") {\r\n\r\n                e = document.createElement(\"ruby\");\r\n\r\n                context.ruby = true;\r\n\r\n            } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"base\") {\r\n\r\n                e = document.createElement(\"rb\");\r\n\r\n            } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"text\") {\r\n\r\n                e = document.createElement(\"rt\");\r\n\r\n\r\n            } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"baseContainer\") {\r\n\r\n                e = document.createElement(\"rbc\");\r\n\r\n\r\n            } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"textContainer\") {\r\n\r\n                e = document.createElement(\"rtc\");\r\n\r\n\r\n            } else if (isd_element.styleAttrs[imscStyles.byName.ruby.qname] === \"delimiter\") {\r\n\r\n                /* ignore rp */\r\n\r\n                return;\r\n\r\n            } else {\r\n\r\n                e = document.createElement(\"span\");\r\n\r\n            }\r\n\r\n            //e.textContent = isd_element.text;\r\n\r\n        } else if (isd_element.kind === 'br') {\r\n\r\n            e = document.createElement(\"br\");\r\n\r\n        }\r\n\r\n        if (!e) {\r\n\r\n            reportError(context.errorHandler, \"Error processing ISD element kind: \" + isd_element.kind);\r\n\r\n            return;\r\n\r\n        }\r\n\r\n        /* set language */\r\n\r\n        if (isd_element.lang) {\r\n\r\n            if (isd_element.kind === 'region' || isd_element.lang !== isd_parent.lang) {\r\n                e.lang = isd_element.lang;\r\n            }\r\n\r\n        }\r\n\r\n        /* add to parent */\r\n\r\n        dom_parent.appendChild(e);\r\n\r\n        /* override UA default margin */\r\n        /* TODO: should apply to <p> only */\r\n\r\n        e.style.margin = \"0\";\r\n\r\n        /* determine ipd and bpd */\r\n\r\n        if (isd_element.kind === \"region\") {\r\n\r\n            var wdir = isd_element.styleAttrs[imscStyles.byName.writingMode.qname];\r\n\r\n            if (wdir === \"lrtb\" || wdir === \"lr\") {\r\n\r\n                context.ipd = \"lr\";\r\n                context.bpd = \"tb\";\r\n\r\n            } else if (wdir === \"rltb\" || wdir === \"rl\") {\r\n\r\n                context.ipd = \"rl\";\r\n                context.bpd = \"tb\";\r\n\r\n            } else if (wdir === \"tblr\") {\r\n\r\n                context.ipd = \"tb\";\r\n                context.bpd = \"lr\";\r\n\r\n            } else if (wdir === \"tbrl\" || wdir === \"tb\") {\r\n\r\n                context.ipd = \"tb\";\r\n                context.bpd = \"rl\";\r\n\r\n            }\r\n \r\n        } else if (isd_element.kind === \"p\" && context.bpd === \"tb\") {\r\n\r\n            var pdir = isd_element.styleAttrs[imscStyles.byName.direction.qname];\r\n\r\n            context.ipd = pdir === \"ltr\" ? \"lr\" : \"rl\"; \r\n \r\n        }\r\n\r\n        /* tranform TTML styles to CSS styles */\r\n\r\n        for (var i = 0; i < STYLING_MAP_DEFS.length; i++) {\r\n\r\n            var sm = STYLING_MAP_DEFS[i];\r\n\r\n            var attr = isd_element.styleAttrs[sm.qname];\r\n\r\n            if (attr !== undefined && sm.map !== null) {\r\n\r\n                sm.map(context, e, isd_element, attr);\r\n\r\n            }\r\n\r\n        }\r\n\r\n        var proc_e = e;\r\n\r\n        /* do we have linePadding ? */\r\n\r\n        var lp = isd_element.styleAttrs[imscStyles.byName.linePadding.qname];\r\n\r\n        if (lp && (! lp.isZero())) {\r\n\r\n            var plength = lp.toUsedLength(context.w, context.h);\r\n\r\n\r\n            if (plength > 0) {\r\n                \r\n                /* apply padding to the <p> so that line padding does not cause line wraps */\r\n\r\n                var padmeasure = Math.ceil(plength) + \"px\";\r\n\r\n                if (context.bpd === \"tb\") {\r\n\r\n                    proc_e.style.paddingLeft = padmeasure;\r\n                    proc_e.style.paddingRight = padmeasure;\r\n\r\n                } else {\r\n\r\n                    proc_e.style.paddingTop = padmeasure;\r\n                    proc_e.style.paddingBottom = padmeasure;\r\n\r\n                }\r\n\r\n                context.lp = lp;\r\n            }\r\n        }\r\n\r\n        // do we have multiRowAlign?\r\n\r\n        var mra = isd_element.styleAttrs[imscStyles.byName.multiRowAlign.qname];\r\n\r\n        if (mra && mra !== \"auto\") {\r\n\r\n            /* create inline block to handle multirowAlign */\r\n\r\n            var s = document.createElement(\"span\");\r\n\r\n            s.style.display = \"inline-block\";\r\n\r\n            s.style.textAlign = mra;\r\n\r\n            e.appendChild(s);\r\n\r\n            proc_e = s;\r\n\r\n            context.mra = mra;\r\n\r\n        }\r\n\r\n        /* do we have rubyReserve? */\r\n\r\n        var rr = isd_element.styleAttrs[imscStyles.byName.rubyReserve.qname];\r\n\r\n        if (rr && rr[0] !== \"none\") {\r\n            context.rubyReserve = rr;\r\n        }\r\n\r\n\r\n        /* remember we are filling line gaps */\r\n\r\n        if (isd_element.styleAttrs[imscStyles.byName.fillLineGap.qname]) {\r\n            context.flg = true;\r\n        }\r\n\r\n\r\n        if (isd_element.kind === \"span\" && isd_element.text) {\r\n\r\n            var te = isd_element.styleAttrs[imscStyles.byName.textEmphasis.qname];\r\n\r\n            if (te && te.style !== \"none\") {\r\n\r\n                context.textEmphasis = true;\r\n\r\n            }\r\n\r\n            if (imscStyles.byName.textCombine.qname in isd_element.styleAttrs &&\r\n                    isd_element.styleAttrs[imscStyles.byName.textCombine.qname] === \"all\") {\r\n\r\n                /* ignore tate-chu-yoku since line break cannot happen within */\r\n                e.textContent = isd_element.text;\r\n\r\n                if (te) {\r\n\r\n                    applyTextEmphasis(context, e, isd_element, te);\r\n\r\n                };\r\n\r\n            } else {\r\n\r\n                // wrap characters in spans to find the line wrap locations\r\n\r\n                var cbuf = '';\r\n\r\n                for (var j = 0; j < isd_element.text.length; j++) {\r\n\r\n                    cbuf += isd_element.text.charAt(j);\r\n\r\n                    var cc = isd_element.text.charCodeAt(j);\r\n\r\n                    if (cc < 0xD800 || cc > 0xDBFF || j === isd_element.text.length - 1) {\r\n\r\n                        /* wrap the character(s) in a span unless it is a high surrogate */\r\n\r\n                        var span = document.createElement(\"span\");\r\n\r\n                        span.textContent = cbuf;\r\n\r\n                        /* apply textEmphasis */\r\n                        \r\n                        if (te) {\r\n\r\n                            applyTextEmphasis(context, span, isd_element, te);\r\n\r\n                        };\r\n    \r\n                        e.appendChild(span);\r\n\r\n                        cbuf = '';\r\n\r\n                        //For the sake of merging these back together, record what isd element generated it.\r\n                        span._isd_element = isd_element;\r\n                    }\r\n\r\n                }\r\n\r\n            }\r\n        }\r\n\r\n        /* process the children of the ISD element */\r\n\r\n        if (\"contents\" in isd_element) {\r\n\r\n            for (var k = 0; k < isd_element.contents.length; k++) {\r\n\r\n                processElement(context, proc_e, isd_element.contents[k], isd_element);\r\n\r\n            }\r\n\r\n        }\r\n\r\n        /* list of lines */\r\n\r\n        var linelist = [];\r\n\r\n\r\n        /* paragraph processing */\r\n        /* TODO: linePadding only supported for horizontal scripts */\r\n\r\n        if (isd_element.kind === \"p\") {\r\n\r\n            constructLineList(context, proc_e, linelist, null);\r\n\r\n            /* apply rubyReserve */\r\n\r\n            if (context.rubyReserve) {\r\n\r\n                applyRubyReserve(linelist, context);\r\n\r\n                context.rubyReserve = null;\r\n\r\n            }\r\n\r\n            /* apply tts:rubyPosition=\"outside\" */\r\n\r\n            if (context.ruby || context.rubyReserve) {\r\n\r\n                applyRubyPosition(linelist, context);\r\n\r\n                context.ruby = null;\r\n\r\n            }\r\n\r\n            /* apply text emphasis \"outside\" position */\r\n\r\n            if (context.textEmphasis) {\r\n\r\n                applyTextEmphasisOutside(linelist, context);\r\n\r\n                context.textEmphasis = null;\r\n\r\n            }\r\n\r\n            /* insert line breaks for multirowalign */\r\n\r\n            if (context.mra) {\r\n\r\n                applyMultiRowAlign(linelist);\r\n\r\n                context.mra = null;\r\n\r\n            }\r\n\r\n            /* add linepadding */\r\n\r\n            if (context.lp) {\r\n\r\n                applyLinePadding(linelist, context.lp.toUsedLength(context.w, context.h), context);\r\n\r\n                context.lp = null;\r\n\r\n            }\r\n\r\n            mergeSpans(linelist); // The earlier we can do this the less processing there will be.\r\n\r\n            /* fill line gaps linepadding */\r\n\r\n            if (context.flg) {\r\n\r\n                var par_edges = rect2edges(proc_e.getBoundingClientRect(), context);\r\n\r\n                applyFillLineGap(linelist, par_edges.before, par_edges.after, context, proc_e);\r\n\r\n                context.flg = null;\r\n\r\n            }\r\n\r\n        }\r\n\r\n\r\n        /* region processing */\r\n\r\n        if (isd_element.kind === \"region\") {\r\n\r\n            /* perform roll up if needed */\r\n            if ((context.bpd === \"tb\") &&\r\n                    context.enableRollUp &&\r\n                    isd_element.contents.length > 0 &&\r\n                    isd_element.styleAttrs[imscStyles.byName.displayAlign.qname] === 'after') {\r\n\r\n                /* build line list */\r\n                constructLineList(context, proc_e, linelist, null);\r\n\r\n                /* horrible hack, perhaps default region id should be underscore everywhere? */\r\n\r\n                var rid = isd_element.id === '' ? '_' : isd_element.id;\r\n\r\n                var rb = new RegionPBuffer(rid, linelist);\r\n\r\n                context.currentISDState[rb.id] = rb;\r\n\r\n                if (context.previousISDState &&\r\n                        rb.id in context.previousISDState &&\r\n                        context.previousISDState[rb.id].plist.length > 0 &&\r\n                        rb.plist.length > 1 &&\r\n                        rb.plist[rb.plist.length - 2].text ===\r\n                        context.previousISDState[rb.id].plist[context.previousISDState[rb.id].plist.length - 1].text) {\r\n\r\n                    var body_elem = e.firstElementChild;\r\n\r\n                    var h = rb.plist[rb.plist.length - 1].after - rb.plist[rb.plist.length - 1].before;\r\n\r\n                    body_elem.style.bottom = \"-\" + h + \"px\";\r\n                    body_elem.style.transition = \"transform 0.4s\";\r\n                    body_elem.style.position = \"relative\";\r\n                    body_elem.style.transform = \"translateY(-\" + h + \"px)\";\r\n\r\n                }\r\n\r\n            }\r\n        }\r\n    }\r\n\r\n    function mergeSpans(lineList) {\r\n\r\n        for (var i = 0; i < lineList.length; i++) {\r\n\r\n            var line = lineList[i];\r\n\r\n            for (var j = 1; j < line.elements.length;) {\r\n\r\n                var previous = line.elements[j - 1];\r\n                var span = line.elements[j];\r\n\r\n                if (spanMerge(previous.node, span.node)) {\r\n\r\n                    //removed from DOM by spanMerge(), remove from the list too.\r\n                    line.elements.splice(j, 1);\r\n                    continue;\r\n\r\n                } else {\r\n\r\n                    j++;\r\n\r\n                }\r\n\r\n            }\r\n        }\r\n\r\n        // Copy backgroundColor to each span so that fillLineGap will apply padding to elements with the right background\r\n        var thisNode, ancestorBackgroundColor;\r\n        var clearTheseBackgrounds = [];\r\n\r\n        for (var l = 0; l < lineList.length; l++) {\r\n\r\n            for (var el = 0; el < lineList[l].elements.length; el++) {\r\n\r\n                thisNode = lineList[l].elements[el].node;\r\n                ancestorBackgroundColor = getSpanAncestorColor(thisNode, clearTheseBackgrounds, false);\r\n\r\n                if (ancestorBackgroundColor) {\r\n\r\n                    thisNode.style.backgroundColor = ancestorBackgroundColor;\r\n\r\n                }\r\n            }\r\n        }\r\n\r\n        for (var bi = 0; bi < clearTheseBackgrounds.length; bi++) {\r\n\r\n            clearTheseBackgrounds[bi].style.backgroundColor = \"\";\r\n\r\n        }\r\n    }\r\n\r\n    function getSpanAncestorColor(element, ancestorList, isAncestor) {\r\n\r\n        if (element.style.backgroundColor) {\r\n\r\n            if (isAncestor && !ancestorList.includes(element)) {\r\n\r\n                ancestorList.push(element);\r\n\r\n            }\r\n            return element.style.backgroundColor;\r\n\r\n        } else {\r\n\r\n            if (element.parentElement.nodeName === \"SPAN\") {\r\n\r\n                return getSpanAncestorColor(element.parentElement, ancestorList, true);\r\n\r\n            }\r\n\r\n        }\r\n\r\n        return undefined;\r\n    }\r\n\r\n    function spanMerge(first, second) {\r\n\r\n        if (first.tagName === \"SPAN\" &&\r\n            second.tagName === \"SPAN\" &&\r\n            first._isd_element === second._isd_element) {\r\n\r\n                first.textContent += second.textContent;\r\n\r\n                for (var i = 0; i < second.style.length; i++) {\r\n\r\n                    var styleName = second.style[i];\r\n                    if (styleName.indexOf(\"border\") >= 0 || \r\n                        styleName.indexOf(\"padding\") >= 0 ||\r\n                        styleName.indexOf(\"margin\") >= 0) {\r\n\r\n                        first.style[styleName] = second.style[styleName];\r\n\r\n                    }\r\n                }\r\n\r\n                second.parentElement.removeChild(second);\r\n\r\n                return true;\r\n            }\r\n\r\n        return false;\r\n    }\r\n\r\n    function applyLinePadding(lineList, lp, context) {\r\n\r\n        if (lineList === null) return;\r\n\r\n        for (var i = 0; i < lineList.length; i++) {\r\n\r\n            var l = lineList[i].elements.length;\r\n\r\n            var pospadpxlen = Math.ceil(lp) + \"px\";\r\n\r\n            var negpadpxlen = \"-\" + Math.ceil(lp) + \"px\";\r\n\r\n            if (l !== 0) {\r\n\r\n                var se = lineList[i].elements[lineList[i].start_elem];\r\n\r\n                var ee = lineList[i].elements[lineList[i].end_elem];\r\n\r\n                if (se === ee) {\r\n\r\n                    // Check to see if there's any background at all\r\n                    elementBoundingRect = se.node.getBoundingClientRect();\r\n                    \r\n                    if (elementBoundingRect.width == 0 || elementBoundingRect.height == 0) {\r\n\r\n                        // There's no background on this line, move on.\r\n                        continue;\r\n\r\n                    }\r\n\r\n                }\r\n\r\n                // Start element\r\n                if (context.ipd === \"lr\") {\r\n\r\n                    se.node.style.marginLeft = negpadpxlen;\r\n                    se.node.style.paddingLeft = pospadpxlen;\r\n\r\n                } else if (context.ipd === \"rl\") {\r\n\r\n                    se.node.style.paddingRight = pospadpxlen;\r\n                    se.node.style.marginRight = negpadpxlen;\r\n\r\n                } else if (context.ipd === \"tb\") {\r\n\r\n                    se.node.style.paddingTop = pospadpxlen;\r\n                    se.node.style.marginTop = negpadpxlen;\r\n\r\n                }\r\n\r\n                // End element\r\n                if (context.ipd === \"lr\") {\r\n\r\n                    ee.node.style.marginRight = negpadpxlen;\r\n                    ee.node.style.paddingRight = pospadpxlen;\r\n\r\n                } else if (context.ipd === \"rl\") {\r\n\r\n                    ee.node.style.paddingLeft = pospadpxlen;\r\n                    ee.node.style.marginLeft = negpadpxlen;\r\n\r\n                } else if (context.ipd === \"tb\") {\r\n\r\n                    ee.node.style.paddingBottom = pospadpxlen;\r\n                    ee.node.style.marginBottom = negpadpxlen;\r\n\r\n                }\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }\r\n\r\n    function applyMultiRowAlign(lineList) {\r\n\r\n        /* apply an explicit br to all but the last line */\r\n\r\n        for (var i = 0; i < lineList.length - 1; i++) {\r\n\r\n            var l = lineList[i].elements.length;\r\n\r\n            if (l !== 0 && lineList[i].br === false) {\r\n                var br = document.createElement(\"br\");\r\n\r\n                var lastnode = lineList[i].elements[l - 1].node;\r\n\r\n                lastnode.parentElement.insertBefore(br, lastnode.nextSibling);\r\n            }\r\n\r\n        }\r\n\r\n    }\r\n\r\n    function applyTextEmphasisOutside(lineList, context) {\r\n\r\n        /* supports \"outside\" only */\r\n\r\n        for (var i = 0; i < lineList.length; i++) {\r\n\r\n            for (var j = 0; j < lineList[i].te.length; j++) {\r\n\r\n                /* skip if position already set */\r\n\r\n                if (lineList[i].te[j].style[TEXTEMPHASISPOSITION_PROP] &&\r\n                    lineList[i].te[j].style[TEXTEMPHASISPOSITION_PROP] !== \"none\")\r\n                    continue;\r\n\r\n                var pos;\r\n\r\n                if (context.bpd === \"tb\") {\r\n\r\n                    pos = (i === 0) ? \"left over\" : \"left under\";\r\n\r\n\r\n                } else {\r\n\r\n                    if (context.bpd === \"rl\") {\r\n\r\n                        pos = (i === 0) ? \"right under\" : \"left under\";\r\n\r\n                    } else {\r\n\r\n                        pos = (i === 0) ? \"left under\" : \"right under\";\r\n\r\n                    }\r\n\r\n                }\r\n\r\n                lineList[i].te[j].style[TEXTEMPHASISPOSITION_PROP] = pos;\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }\r\n\r\n    function applyRubyPosition(lineList, context) {\r\n\r\n        for (var i = 0; i < lineList.length; i++) {\r\n\r\n            for (var j = 0; j < lineList[i].rbc.length; j++) {\r\n\r\n                /* skip if ruby-position already set */\r\n\r\n                if (lineList[i].rbc[j].style[RUBYPOSITION_PROP])\r\n                    continue;\r\n\r\n                var pos;\r\n\r\n                if (RUBYPOSITION_ISWK) {\r\n\r\n                    /* WebKit exception */\r\n\r\n                    pos = (i === 0) ? \"before\" : \"after\";\r\n\r\n                } else if (context.bpd === \"tb\") {\r\n\r\n                    pos = (i === 0) ? \"over\" : \"under\";\r\n\r\n\r\n                } else {\r\n\r\n                    if (context.bpd === \"rl\") {\r\n\r\n                        pos = (i === 0) ? \"over\" : \"under\";\r\n\r\n                    } else {\r\n\r\n                        pos = (i === 0) ? \"under\" : \"over\";\r\n\r\n                    }\r\n\r\n                }\r\n\r\n                lineList[i].rbc[j].style[RUBYPOSITION_PROP] = pos;\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }\r\n\r\n    function applyRubyReserve(lineList, context) {\r\n\r\n        for (var i = 0; i < lineList.length; i++) {\r\n\r\n            var ruby = document.createElement(\"ruby\");\r\n\r\n            var rb = document.createElement(\"rb\");\r\n            rb.textContent = \"\\u200B\";\r\n\r\n            ruby.appendChild(rb);\r\n\r\n            var rt1;\r\n            var rt2;\r\n\r\n            var fs = context.rubyReserve[1].toUsedLength(context.w, context.h) + \"px\";\r\n\r\n            if (context.rubyReserve[0] === \"both\" || (context.rubyReserve[0] === \"outside\" && lineList.length == 1)) {\r\n\r\n                rt1 = document.createElement(\"rtc\");\r\n                rt1.style[RUBYPOSITION_PROP] = RUBYPOSITION_ISWK ? \"after\" : \"under\";\r\n                rt1.textContent = \"\\u200B\";\r\n                rt1.style.fontSize = fs;\r\n\r\n                rt2 = document.createElement(\"rtc\");\r\n                rt2.style[RUBYPOSITION_PROP] = RUBYPOSITION_ISWK ? \"before\" : \"over\";\r\n                rt2.textContent = \"\\u200B\";\r\n                rt2.style.fontSize = fs;\r\n\r\n                ruby.appendChild(rt1);\r\n                ruby.appendChild(rt2);\r\n\r\n            } else {\r\n\r\n                rt1 = document.createElement(\"rtc\");\r\n                rt1.textContent = \"\\u200B\";\r\n                rt1.style.fontSize = fs;\r\n\r\n                var pos;\r\n\r\n                if (context.rubyReserve[0] === \"after\" || (context.rubyReserve[0] === \"outside\" && i > 0)) {\r\n\r\n                    pos = RUBYPOSITION_ISWK ? \"after\" : ((context.bpd === \"tb\" || context.bpd === \"rl\") ? \"under\" : \"over\");\r\n\r\n                } else {\r\n\r\n                    pos = RUBYPOSITION_ISWK ? \"before\" : ((context.bpd === \"tb\" || context.bpd === \"rl\") ? \"over\" : \"under\");\r\n\r\n                }\r\n\r\n                rt1.style[RUBYPOSITION_PROP] = pos;\r\n\r\n                ruby.appendChild(rt1);\r\n\r\n            }\r\n\r\n            /* add in front of the first ruby element of the line, if it exists */\r\n\r\n            var sib = null;\r\n\r\n            for (var j = 0; j < lineList[i].rbc.length; j++) {\r\n\r\n                if (lineList[i].rbc[j].localName === 'ruby') {\r\n\r\n                    sib = lineList[i].rbc[j];\r\n\r\n                    /* copy specified style properties from the sibling ruby container */\r\n                    \r\n                    for (var k = 0; k < sib.style.length; k++) {\r\n\r\n                        ruby.style.setProperty(sib.style.item(k), sib.style.getPropertyValue(sib.style.item(k)));\r\n\r\n                    }\r\n\r\n                    break;\r\n                }\r\n\r\n            }\r\n\r\n            /* otherwise add before first span */\r\n\r\n            sib = sib || lineList[i].elements[0].node;\r\n\r\n            sib.parentElement.insertBefore(ruby, sib);\r\n\r\n        }\r\n\r\n    }\r\n\r\n    function applyFillLineGap(lineList, par_before, par_after, context, element) {\r\n\r\n        /* positive for BPD = lr and tb, negative for BPD = rl */\r\n        var s = Math.sign(par_after - par_before);\r\n\r\n        for (var i = 0; i <= lineList.length; i++) {\r\n\r\n            /* compute frontier between lines */\r\n\r\n            var frontier;\r\n\r\n            if (i === 0) {\r\n\r\n                frontier = Math.round(par_before);\r\n\r\n            } else if (i === lineList.length) {\r\n\r\n                frontier = Math.round(par_after);\r\n\r\n            } else {\r\n\r\n                frontier = Math.round((lineList[i - 1].after + lineList[i].before) / 2);\r\n\r\n            }\r\n\r\n            var padding;\r\n            var l,thisNode;\r\n\r\n            /* before line */\r\n            if (i > 0) {\r\n\r\n                if (lineList[i-1]) {\r\n\r\n                    for (l = 0; l < lineList[i - 1].elements.length; l++) {\r\n\r\n                        thisNode=lineList[i - 1].elements[l];\r\n                        padding = s*(frontier-thisNode.after) + \"px\";\r\n\r\n                        if (context.bpd === \"lr\") {\r\n\r\n                            thisNode.node.style.paddingRight = padding;\r\n\r\n                        } else if (context.bpd === \"rl\") {\r\n\r\n                            thisNode.node.style.paddingLeft = padding;\r\n\r\n                        } else if (context.bpd === \"tb\") {\r\n\r\n                            thisNode.node.style.paddingBottom = padding;\r\n\r\n                        }\r\n\r\n                    }\r\n\r\n                }\r\n\r\n            }\r\n\r\n            /* after line */\r\n            if (i < lineList.length) {\r\n\r\n                for (l = 0; l < lineList[i].elements.length; l++) {\r\n\r\n                    thisNode = lineList[i].elements[l];\r\n                    padding = s * (thisNode.before - frontier) + \"px\";\r\n\r\n                    if (context.bpd === \"lr\") {\r\n\r\n                        thisNode.node.style.paddingLeft = padding;\r\n\r\n                    } else if (context.bpd === \"rl\") {\r\n\r\n                        thisNode.node.style.paddingRight = padding;\r\n\r\n                    } else if (context.bpd === \"tb\") {\r\n\r\n                        thisNode.node.style.paddingTop = padding;\r\n\r\n                    }\r\n                }\r\n\r\n            }\r\n\r\n        }\r\n\r\n    }\r\n\r\n    function RegionPBuffer(id, lineList) {\r\n\r\n        this.id = id;\r\n\r\n        this.plist = lineList;\r\n\r\n    }\r\n\r\n    function rect2edges(rect, context) {\r\n\r\n        var edges = {before: null, after: null, start: null, end: null};\r\n\r\n        if (context.bpd === \"tb\") {\r\n\r\n            edges.before = rect.top;\r\n            edges.after = rect.bottom;\r\n\r\n            if (context.ipd === \"lr\") {\r\n\r\n                edges.start = rect.left;\r\n                edges.end = rect.right;\r\n\r\n            } else {\r\n\r\n                edges.start = rect.right;\r\n                edges.end = rect.left;\r\n            }\r\n\r\n        } else if (context.bpd === \"lr\") {\r\n\r\n            edges.before = rect.left;\r\n            edges.after = rect.right;\r\n            edges.start = rect.top;\r\n            edges.end = rect.bottom;\r\n\r\n        } else if (context.bpd === \"rl\") {\r\n\r\n            edges.before = rect.right;\r\n            edges.after = rect.left;\r\n            edges.start = rect.top;\r\n            edges.end = rect.bottom;\r\n\r\n        }\r\n\r\n        return edges;\r\n\r\n    }\r\n\r\n    function constructLineList(context, element, llist, bgcolor) {\r\n\r\n        if (element.localName === \"rt\" || element.localName === \"rtc\") {\r\n\r\n            /* skip ruby annotations */\r\n\r\n            return;\r\n\r\n        }\r\n\r\n        var curbgcolor = element.style.backgroundColor || bgcolor;\r\n\r\n        if (element.childElementCount === 0) {\r\n\r\n            if (element.localName === 'span' || element.localName === 'rb') {\r\n\r\n                var r = element.getBoundingClientRect();\r\n\r\n                var edges = rect2edges(r, context);\r\n\r\n                if (llist.length === 0 ||\r\n                        (!isSameLine(edges.before, edges.after, llist[llist.length - 1].before, llist[llist.length - 1].after))\r\n                        ) {\r\n                    llist.push({\r\n                        before: edges.before,\r\n                        after: edges.after,\r\n                        start: edges.start,\r\n                        end: edges.end,\r\n                        start_elem: 0,\r\n                        end_elem: 0,\r\n                        elements: [],\r\n                        rbc: [],\r\n                        te: [],\r\n                        text: \"\",\r\n                        br: false\r\n                    });\r\n\r\n                } else {\r\n\r\n                    /* positive for BPD = lr and tb, negative for BPD = rl */\r\n                    var bpd_dir = Math.sign(edges.after - edges.before);\r\n\r\n                    /* positive for IPD = lr and tb, negative for IPD = rl */\r\n                    var ipd_dir = Math.sign(edges.end - edges.start);\r\n\r\n                    /* check if the line height has increased */\r\n\r\n                    if (bpd_dir * (edges.before - llist[llist.length - 1].before) < 0) {\r\n                        llist[llist.length - 1].before = edges.before;\r\n                    }\r\n\r\n                    if (bpd_dir * (edges.after - llist[llist.length - 1].after) > 0) {\r\n                        llist[llist.length - 1].after = edges.after;\r\n                    }\r\n\r\n                    if (ipd_dir * (edges.start - llist[llist.length - 1].start) < 0) {\r\n                        llist[llist.length - 1].start = edges.start;\r\n                        llist[llist.length - 1].start_elem = llist[llist.length - 1].elements.length;\r\n                    }\r\n\r\n                    if (ipd_dir * (edges.end - llist[llist.length - 1].end) > 0) {\r\n                        llist[llist.length - 1].end = edges.end;\r\n                        llist[llist.length - 1].end_elem = llist[llist.length - 1].elements.length;\r\n                    }\r\n\r\n                }\r\n\r\n                llist[llist.length - 1].text += element.textContent;\r\n\r\n                llist[llist.length - 1].elements.push(\r\n                        {\r\n                            node: element,\r\n                            bgcolor: curbgcolor,\r\n                            before: edges.before,\r\n                            after: edges.after\r\n                        }\r\n                );\r\n\r\n            } else if (element.localName === 'br' && llist.length !== 0) {\r\n\r\n                llist[llist.length - 1].br = true;\r\n\r\n            }\r\n\r\n        } else {\r\n\r\n            var child = element.firstChild;\r\n\r\n            while (child) {\r\n\r\n                if (child.nodeType === Node.ELEMENT_NODE) {\r\n\r\n                    constructLineList(context, child, llist, curbgcolor);\r\n\r\n                    if (child.localName === 'ruby' || child.localName === 'rtc') {\r\n\r\n                        /* remember non-empty ruby and rtc elements so that tts:rubyPosition can be applied */\r\n\r\n                        if (llist.length > 0) {\r\n\r\n                            llist[llist.length - 1].rbc.push(child);\r\n\r\n                        }\r\n\r\n                    } else if (child.localName === 'span' &&\r\n                            child.style[TEXTEMPHASISSTYLE_PROP] &&\r\n                            child.style[TEXTEMPHASISSTYLE_PROP] !== \"none\") {\r\n\r\n                        /* remember non-empty span elements with textEmphasis */\r\n\r\n                        if (llist.length > 0) {\r\n\r\n                            llist[llist.length - 1].te.push(child);\r\n\r\n                        }\r\n\r\n                    }\r\n                    \r\n\r\n                }\r\n\r\n                child = child.nextSibling;\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n    function isSameLine(before1, after1, before2, after2) {\r\n\r\n        return ((after1 < after2) && (before1 > before2)) || ((after2 <= after1) && (before2 >= before1));\r\n\r\n    }\r\n\r\n    function applyTextEmphasis(context, dom_element, isd_element, attr) {\r\n\r\n        /* ignore color (not used in IMSC 1.1) */\r\n\r\n        if (attr.style === \"none\") {\r\n\r\n            /* text-emphasis is not inherited and the default is none, so nothing to do */\r\n            \r\n            return;\r\n        \r\n        } else if (attr.style === \"auto\") {\r\n\r\n            dom_element.style[TEXTEMPHASISSTYLE_PROP] = \"filled\";\r\n        \r\n        } else {\r\n\r\n            dom_element.style[TEXTEMPHASISSTYLE_PROP] =  attr.style + \" \" + attr.symbol;\r\n        }\r\n\r\n        /* ignore \"outside\" position (set in postprocessing) */\r\n\r\n        if (attr.position === \"before\" || attr.position === \"after\") {\r\n\r\n            var pos;\r\n\r\n            if (context.bpd === \"tb\") {\r\n\r\n                pos = (attr.position === \"before\") ? \"left over\" : \"left under\";\r\n\r\n\r\n            } else {\r\n\r\n                if (context.bpd === \"rl\") {\r\n\r\n                    pos = (attr.position === \"before\") ? \"right under\" : \"left under\";\r\n\r\n                } else {\r\n\r\n                    pos = (attr.position === \"before\") ? \"left under\" : \"right under\";\r\n\r\n                }\r\n\r\n            }\r\n\r\n            dom_element.style[TEXTEMPHASISPOSITION_PROP] = pos;\r\n        }\r\n    }\r\n\r\n    function HTMLStylingMapDefinition(qName, mapFunc) {\r\n        this.qname = qName;\r\n        this.map = mapFunc;\r\n    }\r\n\r\n    var STYLING_MAP_DEFS = [\r\n\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling backgroundColor\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    /* skip if transparent */\r\n                    if (attr[3] === 0)\r\n                        return;\r\n\r\n                    dom_element.style.backgroundColor = \"rgba(\" +\r\n                            attr[0].toString() + \",\" +\r\n                            attr[1].toString() + \",\" +\r\n                            attr[2].toString() + \",\" +\r\n                            (attr[3] / 255).toString() +\r\n                            \")\";\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling color\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.color = \"rgba(\" +\r\n                            attr[0].toString() + \",\" +\r\n                            attr[1].toString() + \",\" +\r\n                            attr[2].toString() + \",\" +\r\n                            (attr[3] / 255).toString() +\r\n                            \")\";\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling direction\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    dom_element.style.direction = attr;\r\n\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling display\",\r\n                function (context, dom_element, isd_element, attr) {}\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling displayAlign\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    /* see https://css-tricks.com/snippets/css/a-guide-to-flexbox/ */\r\n\r\n                    /* TODO: is this affected by writing direction? */\r\n\r\n                    dom_element.style.display = \"flex\";\r\n                    dom_element.style.flexDirection = \"column\";\r\n\r\n\r\n                    if (attr === \"before\") {\r\n\r\n                        dom_element.style.justifyContent = \"flex-start\";\r\n\r\n                    } else if (attr === \"center\") {\r\n\r\n                        dom_element.style.justifyContent = \"center\";\r\n\r\n                    } else if (attr === \"after\") {\r\n\r\n                        dom_element.style.justifyContent = \"flex-end\";\r\n                    }\r\n\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling extent\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    /* TODO: this is super ugly */\r\n\r\n                    context.regionH = attr.h.toUsedLength(context.w, context.h);\r\n                    context.regionW = attr.w.toUsedLength(context.w, context.h);\r\n\r\n                    /* \r\n                     * CSS height/width are measured against the content rectangle,\r\n                     * whereas TTML height/width include padding\r\n                     */\r\n\r\n                    var hdelta = 0;\r\n                    var wdelta = 0;\r\n\r\n                    var p = isd_element.styleAttrs[\"http://www.w3.org/ns/ttml#styling padding\"];\r\n\r\n                    if (!p) {\r\n\r\n                        /* error */\r\n\r\n                    } else {\r\n\r\n                        hdelta = p[0].toUsedLength(context.w, context.h) + p[2].toUsedLength(context.w, context.h);\r\n                        wdelta = p[1].toUsedLength(context.w, context.h) + p[3].toUsedLength(context.w, context.h);\r\n\r\n                    }\r\n\r\n                    dom_element.style.height = (context.regionH - hdelta) + \"px\";\r\n                    dom_element.style.width = (context.regionW - wdelta) + \"px\";\r\n\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling fontFamily\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    var rslt = [];\r\n\r\n                    /* per IMSC1 */\r\n\r\n                    for (var i = 0; i < attr.length; i++) {\r\n\r\n                        if (attr[i] === \"monospaceSerif\") {\r\n\r\n                            rslt.push(\"Courier New\");\r\n                            rslt.push('\"Liberation Mono\"');\r\n                            rslt.push(\"Courier\");\r\n                            rslt.push(\"monospace\");\r\n\r\n                        } else if (attr[i] === \"proportionalSansSerif\") {\r\n\r\n                            rslt.push(\"Arial\");\r\n                            rslt.push(\"Helvetica\");\r\n                            rslt.push('\"Liberation Sans\"');\r\n                            rslt.push(\"sans-serif\");\r\n\r\n                        } else if (attr[i] === \"monospace\") {\r\n\r\n                            rslt.push(\"monospace\");\r\n\r\n                        } else if (attr[i] === \"sansSerif\") {\r\n\r\n                            rslt.push(\"sans-serif\");\r\n\r\n                        } else if (attr[i] === \"serif\") {\r\n\r\n                            rslt.push(\"serif\");\r\n\r\n                        } else if (attr[i] === \"monospaceSansSerif\") {\r\n\r\n                            rslt.push(\"Consolas\");\r\n                            rslt.push(\"monospace\");\r\n\r\n                        } else if (attr[i] === \"proportionalSerif\") {\r\n\r\n                            rslt.push(\"serif\");\r\n\r\n                        } else {\r\n\r\n                            rslt.push(attr[i]);\r\n\r\n                        }\r\n\r\n                    }\r\n\r\n                    // prune later duplicates we may have inserted \r\n                    if (rslt.length > 0) {\r\n\r\n                        var unique=[rslt[0]];\r\n\r\n                        for (var fi = 1; fi < rslt.length; fi++) {\r\n\r\n                            if (unique.indexOf(rslt[fi]) == -1) {\r\n\r\n                                unique.push(rslt[fi]);\r\n\r\n                            }\r\n                        }\r\n\r\n                        rslt = unique;\r\n                    }\r\n\r\n                    dom_element.style.fontFamily = rslt.join(\",\");\r\n                }\r\n        ),\r\n\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling shear\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    /* return immediately if tts:shear is 0% since CSS transforms are not inherited*/\r\n\r\n                    if (attr === 0)\r\n                        return;\r\n\r\n                    var angle = attr * -0.9;\r\n\r\n                    /* context.bpd is needed since writing mode is not inherited and sets the inline progression */\r\n\r\n                    if (context.bpd === \"tb\") {\r\n\r\n                        dom_element.style.transform = \"skewX(\" + angle + \"deg)\";\r\n\r\n                    } else {\r\n\r\n                        dom_element.style.transform = \"skewY(\" + angle + \"deg)\";\r\n\r\n                    }\r\n\r\n                }\r\n        ),\r\n\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling fontSize\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.fontSize = attr.toUsedLength(context.w, context.h) + \"px\";\r\n                }\r\n        ),\r\n\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling fontStyle\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.fontStyle = attr;\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling fontWeight\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.fontWeight = attr;\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling lineHeight\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    if (attr === \"normal\") {\r\n\r\n                        dom_element.style.lineHeight = \"normal\";\r\n\r\n                    } else {\r\n\r\n                        dom_element.style.lineHeight = attr.toUsedLength(context.w, context.h) + \"px\";\r\n                    }\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling opacity\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.opacity = attr;\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling origin\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.top = attr.h.toUsedLength(context.w, context.h) + \"px\";\r\n                    dom_element.style.left = attr.w.toUsedLength(context.w, context.h) + \"px\";\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling overflow\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.overflow = attr;\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling padding\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    /* attr: top,left,bottom,right*/\r\n\r\n                    /* style: top right bottom left*/\r\n\r\n                    var rslt = [];\r\n\r\n                    rslt[0] = attr[0].toUsedLength(context.w, context.h) + \"px\";\r\n                    rslt[1] = attr[3].toUsedLength(context.w, context.h) + \"px\";\r\n                    rslt[2] = attr[2].toUsedLength(context.w, context.h) + \"px\";\r\n                    rslt[3] = attr[1].toUsedLength(context.w, context.h) + \"px\";\r\n\r\n                    dom_element.style.padding = rslt.join(\" \");\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling position\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.top = attr.h.toUsedLength(context.w, context.h) + \"px\";\r\n                    dom_element.style.left = attr.w.toUsedLength(context.w, context.h) + \"px\";\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling rubyAlign\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.rubyAlign = attr === \"spaceAround\" ? \"space-around\" : \"center\";\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling rubyPosition\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    /* skip if \"outside\", which is handled by applyRubyPosition() */\r\n\r\n                    if (attr === \"before\" || attr === \"after\") {\r\n\r\n                        var pos;\r\n\r\n                        if (RUBYPOSITION_ISWK) {\r\n\r\n                            /* WebKit exception */\r\n        \r\n                            pos = attr;\r\n        \r\n                        } else if (context.bpd === \"tb\") {\r\n\r\n                            pos = (attr === \"before\") ? \"over\" : \"under\";\r\n\r\n\r\n                        } else {\r\n\r\n                            if (context.bpd === \"rl\") {\r\n\r\n                                pos = (attr === \"before\") ? \"over\" : \"under\";\r\n\r\n                            } else {\r\n\r\n                                pos = (attr === \"before\") ? \"under\" : \"over\";\r\n\r\n                            }\r\n\r\n                        }\r\n\r\n                        /* apply position to the parent dom_element, i.e. ruby or rtc */\r\n\r\n                        dom_element.parentElement.style[RUBYPOSITION_PROP] = pos;\r\n                    }\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling showBackground\",\r\n                null\r\n                ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling textAlign\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    var ta;\r\n\r\n                    /* handle UAs that do not understand start or end */\r\n\r\n                    if (attr === \"start\") {\r\n\r\n                        ta = (context.ipd === \"rl\") ? \"right\" : \"left\";\r\n\r\n                    } else if (attr === \"end\") {\r\n\r\n                        ta = (context.ipd === \"rl\") ? \"left\" : \"right\";\r\n\r\n                    } else {\r\n\r\n                        ta = attr;\r\n\r\n                    }\r\n\r\n                    dom_element.style.textAlign = ta;\r\n\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling textDecoration\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.textDecoration = attr.join(\" \").replace(\"lineThrough\", \"line-through\");\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling textOutline\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    /* defer to tts:textShadow */\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling textShadow\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    var txto = isd_element.styleAttrs[imscStyles.byName.textOutline.qname];\r\n\r\n                    if (attr === \"none\" && txto === \"none\") {\r\n\r\n                        dom_element.style.textShadow = \"\";\r\n\r\n                    } else {\r\n\r\n                        var s = [];\r\n\r\n                        if (txto !== \"none\") {\r\n\r\n                            /* emulate text outline */\r\n\r\n                            var to_color = \"rgba(\" +\r\n                                                txto.color[0].toString() + \",\" +\r\n                                                txto.color[1].toString() + \",\" +\r\n                                                txto.color[2].toString() + \",\" +\r\n                                                (txto.color[3] / 255).toString() +\r\n                                                \")\";\r\n\r\n                            s.push(  \"1px 1px 1px \" + to_color);\r\n                            s.push(  \"-1px 1px 1px \" + to_color);\r\n                            s.push(  \"1px -1px 1px \" + to_color);\r\n                            s.push(  \"-1px -1px 1px \" + to_color);\r\n\r\n                        }\r\n\r\n                        /* add text shadow */\r\n\r\n                        if (attr !== \"none\") {\r\n\r\n                            for (var i = 0; i < attr.length; i++) {\r\n\r\n\r\n                                s.push(attr[i].x_off.toUsedLength(context.w, context.h) + \"px \" +\r\n                                        attr[i].y_off.toUsedLength(context.w, context.h) + \"px \" +\r\n                                        attr[i].b_radius.toUsedLength(context.w, context.h) + \"px \" +\r\n                                        \"rgba(\" +\r\n                                        attr[i].color[0].toString() + \",\" +\r\n                                        attr[i].color[1].toString() + \",\" +\r\n                                        attr[i].color[2].toString() + \",\" +\r\n                                        (attr[i].color[3] / 255).toString() +\r\n                                        \")\"\r\n                                        );\r\n\r\n                            }\r\n\r\n                        }\r\n\r\n                        dom_element.style.textShadow = s.join(\",\");\r\n\r\n                    }\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling textCombine\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    dom_element.style.textCombineUpright = attr;\r\n\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling textEmphasis\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    /* applied as part of HTML document construction */\r\n\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling unicodeBidi\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    var ub;\r\n\r\n                    if (attr === 'bidiOverride') {\r\n                        ub = \"bidi-override\";\r\n                    } else {\r\n                        ub = attr;\r\n                    }\r\n\r\n                    dom_element.style.unicodeBidi = ub;\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling visibility\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.visibility = attr;\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling wrapOption\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    if (attr === \"wrap\") {\r\n\r\n                        if (isd_element.space === \"preserve\") {\r\n                            dom_element.style.whiteSpace = \"pre-wrap\";\r\n                        } else {\r\n                            dom_element.style.whiteSpace = \"normal\";\r\n                        }\r\n\r\n                    } else {\r\n\r\n                        if (isd_element.space === \"preserve\") {\r\n\r\n                            dom_element.style.whiteSpace = \"pre\";\r\n\r\n                        } else {\r\n                            dom_element.style.whiteSpace = \"noWrap\";\r\n                        }\r\n\r\n                    }\r\n\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling writingMode\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    var wm;\r\n\r\n                    if (attr === \"lrtb\" || attr === \"lr\") {\r\n\r\n                        dom_element.style.writingMode = \"horizontal-tb\";\r\n\r\n                    } else if (attr === \"rltb\" || attr === \"rl\") {\r\n\r\n                        dom_element.style.writingMode = \"horizontal-tb\";\r\n\r\n                    } else if (attr === \"tblr\") {\r\n\r\n                        dom_element.style.writingMode = \"vertical-lr\";\r\n\r\n                    } else if (attr === \"tbrl\" || attr === \"tb\") {\r\n\r\n                        dom_element.style.writingMode = \"vertical-rl\";\r\n\r\n                    }\r\n\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml#styling zIndex\",\r\n                function (context, dom_element, isd_element, attr) {\r\n                    dom_element.style.zIndex = attr;\r\n                }\r\n        ),\r\n        new HTMLStylingMapDefinition(\r\n                \"http://www.w3.org/ns/ttml/profile/imsc1#styling forcedDisplay\",\r\n                function (context, dom_element, isd_element, attr) {\r\n\r\n                    if (context.displayForcedOnlyMode && attr === false) {\r\n                        dom_element.style.visibility = \"hidden\";\r\n                    }\r\n\r\n                }\r\n        )\r\n    ];\r\n\r\n    var STYLMAP_BY_QNAME = {};\r\n\r\n    for (var i = 0; i < STYLING_MAP_DEFS.length; i++) {\r\n\r\n        STYLMAP_BY_QNAME[STYLING_MAP_DEFS[i].qname] = STYLING_MAP_DEFS[i];\r\n    }\r\n\r\n    /* CSS property names */\r\n\r\n    var RUBYPOSITION_ISWK = \"webkitRubyPosition\" in window.getComputedStyle(document.documentElement);\r\n\r\n    var RUBYPOSITION_PROP = RUBYPOSITION_ISWK ? \"webkitRubyPosition\" : \"rubyPosition\";\r\n\r\n    var TEXTEMPHASISSTYLE_PROP = \"webkitTextEmphasisStyle\" in window.getComputedStyle(document.documentElement) ? \"webkitTextEmphasisStyle\" : \"textEmphasisStyle\";\r\n\r\n    var TEXTEMPHASISPOSITION_PROP = \"webkitTextEmphasisPosition\" in window.getComputedStyle(document.documentElement) ? \"webkitTextEmphasisPosition\" : \"textEmphasisPosition\";\r\n\r\n    /* error utilities */\r\n\r\n    function reportError(errorHandler, msg) {\r\n\r\n        if (errorHandler && errorHandler.error && errorHandler.error(msg))\r\n            throw msg;\r\n\r\n    }\r\n\r\n})(typeof exports === 'undefined' ? this.imscHTML = {} : exports,\r\n        typeof imscNames === 'undefined' ? require(\"./names\") : imscNames,\r\n        typeof imscStyles === 'undefined' ? require(\"./styles\") : imscStyles,\r\n        typeof imscUtils === 'undefined' ? require(\"./utils\") : imscUtils);\r\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}